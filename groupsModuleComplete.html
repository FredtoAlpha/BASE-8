<script>
(function(global) {
  'use strict';

  /*
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    MODULE COMPLET DE GESTION DES GROUPES
    - Groupes de Besoins (scores Math/FranÃ§ais)
    - Groupes LV2 (ESP/ITA/autres langues)
    - Groupes Options (future extension)
    - Drag & Drop entre groupes
    - Export GROUPES / PDF / CSV
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  */

  // VERSION 4.0 - Octobre 2025 - GROUPS MODULE (NE PAS SUPPRIMER)

  const windowRef =
    typeof window !== 'undefined'
      ? window
      : (typeof globalThis !== 'undefined' ? globalThis : undefined);
  const documentRef = windowRef?.document;

  if (!windowRef || !documentRef) {
    console.log('âŒ GroupsModuleComplete: environnement navigateur non dÃ©tectÃ©');
    return;
  }

  console.log('ğŸš€ Chargement du Module Complet de Gestion des Groupes...');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CONSTANTES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const GROUP_TYPES = {
    needs: {
      id: 'needs',
      title: 'Groupes de Besoins',
      description: 'Groupes hÃ©tÃ©rogÃ¨nes basÃ©s sur les scores Math/FranÃ§ais et critÃ¨res pÃ©dagogiques',
      icon: 'ğŸ“Š',
      color: 'from-blue-600 to-indigo-600',
      bgColor: 'bg-blue-50',
      borderColor: 'border-blue-200'
    },
    language: {
      id: 'language',
      title: 'Groupes LV2',
      description: 'Groupes de langues (ESP/ITA) avec prioritÃ© Ã  la participation',
      icon: 'ğŸ—£ï¸',
      color: 'from-purple-600 to-pink-600',
      bgColor: 'bg-purple-50',
      borderColor: 'border-purple-200'
    },
    option: {
      id: 'option',
      title: 'Groupes Options',
      description: 'Groupes basÃ©s sur les options choisies (Ã  venir)',
      icon: 'ğŸ¨',
      color: 'from-emerald-600 to-teal-600',
      bgColor: 'bg-emerald-50',
      borderColor: 'border-emerald-200',
      disabled: true
    }
  };

  const SUBJECTS = {
    both: { id: 'both', label: 'Math + FranÃ§ais', icon: 'ğŸ“ğŸ“š' },
    maths: { id: 'maths', label: 'MathÃ©matiques', icon: 'ğŸ“' },
    french: { id: 'french', label: 'FranÃ§ais', icon: 'ğŸ“š' }
  };

  const DISTRIBUTION_TYPES = {
    heterogeneous: { id: 'heterogeneous', label: 'HÃ©tÃ©rogÃ¨ne (tous niveaux mÃ©langÃ©s)', recommended: true },
    homogeneous: { id: 'homogeneous', label: 'HomogÃ¨ne (par niveau)' }
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  Ã‰TAT GLOBAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const state = {
    // Navigation
    currentStep: 1,
    totalSteps: 5,

    // Configuration
    groupType: null,                    // 'needs' | 'language' | 'option'
    selectedClasses: [],                // ['6Â°1', '6Â°2', ...] (noms affichage)
    availableClasses: [],               // Classes visibles dans le board
    numGroups: 3,                       // Nombre de groupes Ã  crÃ©er

    // Config spÃ©cifique Besoins
    selectedSubject: 'both',            // 'both' | 'maths' | 'french'
    distributionType: 'heterogeneous',  // 'heterogeneous' | 'homogeneous'

    // Config spÃ©cifique LV2
    selectedLanguage: 'ESP',            // 'ESP' | 'ITA' | autre
    availableLanguages: [],             // Langues dÃ©tectÃ©es

    // ğŸ†• DonnÃ©es brutes et mapping
    classesData: {},                    // Dump brut du backend : { "6Â°1FIN": { eleves:[...] }, ... }
    classKeyMap: {},                    // Mapping affichage -> backend : { "6Â°1": "6Â°1FIN", ... }

    // DonnÃ©es
    students: [],                       // Tous les Ã©lÃ¨ves des classes sÃ©lectionnÃ©es
    studentsById: new Map(),            // Map pour accÃ¨s rapide
    generatedGroups: [],                // Groupes gÃ©nÃ©rÃ©s

    // UI
    modal: null,
    isLoading: false,
    loadError: null,
    lastGeneration: null,

    // Drag & Drop
    sortables: [],

    // Statistiques
    showStatistics: true,

    // ğŸ†• Mode de sauvegarde (pour workflow multi-phase)
    saveMode: 'append',                 // 'replace' | 'append' (dÃ©faut append pour workflow multi-phase)

    // ğŸ†• Persistance multi-vagues
    tempOffsetStart: 1,                 // NumÃ©ro de dÃ©part pour les groupes TEMP (grBe1, grBe2, etc.)
    lastTempRange: null,                // MÃ©morize: { min: 1, max: 3, count: 3 } aprÃ¨s chaque sauvegarde
    persistMode: false,                 // Si true, ne pas rÃ©initialiser les groupes au reset

    // ğŸ†• SPRINT #1 : Persistance
    continuationLoaded: false           // Drapeau pour ne charger continuation qu'une fois
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  UTILITAIRES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function qs(selector, scope = documentRef) {
    return scope?.querySelector(selector);
  }

  function qsa(selector, scope = documentRef) {
    return Array.from(scope?.querySelectorAll(selector) || []);
  }

  function showToast(message, type = 'info', duration = 3500) {
    try {
      const toast = documentRef.createElement('div');
      toast.className = 'fixed top-6 right-6 z-[9999] px-6 py-4 rounded-2xl shadow-2xl text-white font-semibold flex items-center gap-3 animate-slide-in';

      const colors = {
        error: 'linear-gradient(135deg, #ef4444, #dc2626)',
        success: 'linear-gradient(135deg, #22c55e, #16a34a)',
        warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
        info: 'linear-gradient(135deg, #6366f1, #7c3aed)'
      };

      const icons = {
        error: 'fa-circle-exclamation',
        success: 'fa-circle-check',
        warning: 'fa-triangle-exclamation',
        info: 'fa-circle-info'
      };

      toast.style.background = colors[type] || colors.info;
      toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i><span>${message}</span>`;

      documentRef.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-10px)';
        setTimeout(() => toast.remove(), 250);
      }, duration);
    } catch (error) {
      console.error('âŒ Erreur showToast:', error);
    }
  }

  function formatDate(date) {
    return new Date(date).toLocaleString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  NORMALISATION DES SCORES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Fallback pour les scores manquants ou mal formatÃ©s
  // GÃ¨re les trois formats : scores.F/M, scoreF/scoreM, SCORE_F/SCORE_M
  function normalizeScores(student) {
    if (!student) return student;

    const toNum = v => (v === '' || v == null) ? null : Number(v);

    // Chercher F (FranÃ§ais) dans les trois lieux possibles
    const f = toNum(
      student?.scores?.F ??
      student?.scoreF ??
      student?.SCORE_F ??
      null
    );

    // Chercher M (MathÃ©matiques) dans les trois lieux possibles
    const m = toNum(
      student?.scores?.M ??
      student?.scoreM ??
      student?.SCORE_M ??
      null
    );

    // Garantir la structure scores.F/M
    if (!student.scores) {
      student.scores = {};
    }
    student.scores.F = Number.isFinite(f) ? f : null;
    student.scores.M = Number.isFinite(m) ? m : null;

    // Garder aussi les top-level pour compatibilitÃ©
    student.scoreF = student.scores.F;
    student.scoreM = student.scores.M;

    return student;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  DÃ‰TECTION DES VRAIES CLASSES PÃ‰DAGOGIQUES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Helper : Transforme un nom de classe en forme CANONIQUE pour comparaison.
  // Exemples :
  //   "6Â°1" â†’ "6#1"
  //   "6Â°2FIN" â†’ "6#2"
  //   "6E2FIN" â†’ "6#2"
  //   "3E1" â†’ "3#1"
  // Ã‡a permet de matcher "6Â°1" (DOM) avec "6E1FIN" (backend) via leur forme canonique commune.
  function canonicalClass(name) {
    let s = (name || '')
      .toString()
      .trim()
      .toUpperCase();

    // Unifie "6Â°2" et "6E2" â†’ "6#2"
    s = s.replace(/^(\d)[EÂ°]/, '$1#');

    // Retire tout ce qui n'est pas [0-9 A-Z #]
    s = s.replace(/[^0-9A-Z#]/g, '');

    return s;
  }

  // Helper : Est-ce que ce nom est une vraie classe pÃ©dagogique (ex: "6Â°1", "5Â°2", "3E2") ?
  // Rejette les groupes, CHAV, DYS, soutien, besoins, LV2, etc.
  function localIsRealClass(name) {
    if (!name || typeof name !== 'string') return false;

    name = name.trim();

    // Patterns d'exclusion : trucs techniques, groupes de besoin, etc.
    const badPatterns = [
      /^GROUPE/i,
      /^GRP/i,
      /GROUPE/i,
      /_LV2/i,
      /_LV1/i,
      /_LV3/i,
      /_CHAV/i,
      /_DYS/i,
      /_SOUTIEN/i,
      /_BESOINS/i,
    ];

    for (const p of badPatterns) {
      if (p.test(name)) return false;
    }

    // Pattern cible : "6Â°1", "5Â°2", "3E2", etc.
    // On accepte chiffre + (Â° ou E) + chiffre
    const pedagogicPattern = /^(\d+[Â°E]\d+)$/i;
    return pedagogicPattern.test(name);
  }

  // DÃ©tecte les vraies classes directement dans le DOM (colonnes visibles du board)
  // C'est la "vÃ©ritÃ© de terrain" pour le chef d'Ã©tablissement
  function detectClassesFromDOM() {
    const zones = documentRef.querySelectorAll('.droppable-zone[data-classe]');
    const list = [];

    zones.forEach(z => {
      const cid = (z.getAttribute('data-classe') || '').trim();
      if (cid && localIsRealClass(cid) && !list.includes(cid)) {
        list.push(cid);
      }
    });

    return list;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SNAPSHOT DES CLASSES ET Ã‰LÃˆVES DEPUIS LE DOM
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Reconstruit un snapshot { "6Â°1": { eleves:[ {...}, {...} ] }, ... }
  // en lisant DIRECTEMENT le board visible.
  // Source unique de vÃ©ritÃ© : ce que le chef voit Ã  l'Ã©cran.
  function snapshotClassesFromDOMForGroups() {
    const zones = documentRef.querySelectorAll('.droppable-zone[data-classe]');
    const snapshot = {};

    zones.forEach(zone => {
      const classId = (zone.getAttribute('data-classe') || '').trim();
      if (!classId) return;
      if (!localIsRealClass(classId)) return;

      // PrÃ©pare le bucket pour cette classe
      snapshot[classId] = { eleves: [] };

      // RÃ©cupÃ¨re toutes les cartes Ã©lÃ¨ves visibles dans cette classe
      const cards = zone.querySelectorAll('.student-card');

      cards.forEach(card => {
        // ID Ã©lÃ¨ve : on accepte les deux syntaxes
        const sid =
          card.getAttribute('data-id') ||
          card.getAttribute('data-student-id') ||
          card.dataset.id ||
          card.dataset.studentId;

        if (!sid) return;

        // On va chercher la fiche complÃ¨te dans STATE.students
        const fullData = windowRef.STATE?.students?.[sid];

        if (fullData) {
          // On clone pour ne pas muter l'original
          const clone = { ...fullData };

          // On force la classe actuelle visible
          clone.classe = classId;

          snapshot[classId].eleves.push(clone);
        } else {
          // Fallback ultra-minimal si jamais l'Ã©lÃ¨ve n'est pas dans STATE.students
          const nom = (card.querySelector('.sc-nom')?.textContent || '').trim();
          const prenom = (card.querySelector('.sc-prenom')?.textContent || '').trim();
          const sexe = card.getAttribute('data-sexe') ||
                       card.querySelector('.tag-sex')?.textContent?.trim() ||
                       '';
          const source = card.getAttribute('data-source') || ''; // classe d'origine

          snapshot[classId].eleves.push({
            id: sid,
            nom,
            prenom,
            sexe,
            classe: classId,
            source: source,
            scores: {} // pas idÃ©al mais Ã§a Ã©vite les crash
          });
        }
      });
    });

    // Debug utile
    Object.keys(snapshot).forEach(cid => {
      console.log(
        `[GroupsModule] Snapshot DOM â†’ ${cid}: ${snapshot[cid].eleves.length} Ã©lÃ¨ves`
      );
    });

    return snapshot;
  }

  // ========== FONCTION HELPER POUR SIMPLIFIER LES NOMS COMPOSÃ‰S ==========
  // Utilise la version globale 4.3 dÃ©finie dans InterfaceV2_CoreScript
  // Plus de doublon - rÃ©fÃ©rence unique
  
  function simplifierNomComplet(nom, prenom) {
    // Utiliser la version globale 4.3 si disponible
    if (
      windowRef.simplifierNomComplet &&
      typeof windowRef.simplifierNomComplet === 'function'
    ) {
      return windowRef.simplifierNomComplet(nom, prenom);
    }

    // Fallback simple si la version globale n'est pas chargÃ©e
    console.warn('âš ï¸ Version globale simplifierNomComplet non trouvÃ©e, utilisation fallback');
    if (!nom && !prenom) return '';
    const nomSimple = (nom || '').trim().split(/[\s-]+/)[0];
    const prenomSimple = (prenom || '').trim().split(/[\s-]+/)[0];
    return `${nomSimple} ${prenomSimple}`.trim();
  }

  console.log('âœ… GroupsModule - Utilise simplifierNomComplet VERSION 4.3 globale');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CRÃ‰ATION DE LA MODAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function createModal() {
    closeModal();

    const overlay = documentRef.createElement('div');
    overlay.className = 'fixed inset-0 z-[9998] flex items-center justify-center bg-slate-900/70 px-4 animate-fade-in';
    overlay.dataset.groupsModal = 'complete';

    const panel = documentRef.createElement('div');
    panel.className = 'bg-white rounded-3xl shadow-2xl w-full max-w-[95vw] max-h-[95vh] overflow-hidden flex flex-col';

    panel.innerHTML = `
      <header class="px-8 pt-8 pb-6 border-b border-slate-200 bg-gradient-to-br from-indigo-50 via-white to-purple-50">
        <div class="flex items-start justify-between gap-6 mb-6">
          <div class="flex items-center gap-4">
            <div class="h-14 w-14 rounded-2xl bg-gradient-to-br ${state.groupType ? GROUP_TYPES[state.groupType].color : 'from-slate-400 to-slate-600'} flex items-center justify-center text-3xl shadow-lg">
              ${state.groupType ? GROUP_TYPES[state.groupType].icon : 'âœ¨'}
            </div>
            <div>
              <h2 class="text-2xl font-bold text-slate-900">CrÃ©ation de Groupes</h2>
              <p class="text-sm text-slate-600 mt-1">
                ${state.groupType ? GROUP_TYPES[state.groupType].title : 'Assistant intelligent de crÃ©ation de groupes'}
              </p>
            </div>
          </div>
          <button type="button" class="text-slate-400 hover:text-slate-600 transition-colors p-2" data-action="close">
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>

        <nav class="flex items-center gap-2" data-stepper>
          ${[1, 2, 3, 4, 5].map(step => `
            <div class="flex items-center gap-2 flex-1">
              <div class="stepper-step ${step <= state.currentStep ? 'active' : ''} ${step === state.currentStep ? 'current' : ''}" data-step="${step}">
                <span class="step-number">${step}</span>
                <span class="step-label">${getStepLabel(step)}</span>
              </div>
              ${step < 5 ? '<div class="step-connector"></div>' : ''}
            </div>
          `).join('')}
        </nav>
      </header>

      <div class="flex-1 overflow-y-auto px-8 py-8" data-step-container>
        ${renderStepContent()}
      </div>

      <footer class="border-t border-slate-200 bg-slate-50 px-8 py-5 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3 text-sm text-slate-600" data-footer-info>
          ${getFooterInfo()}
        </div>
        <div class="flex items-center gap-3">
          <button type="button" class="px-5 py-2.5 rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold transition-colors" data-action="secondary">
            ${getSecondaryButtonLabel()}
          </button>
          <button type="button" class="px-5 py-2.5 rounded-xl bg-gradient-to-r ${state.groupType ? GROUP_TYPES[state.groupType].color : 'from-indigo-600 to-purple-600'} text-white font-semibold shadow-lg hover:shadow-xl transition-all" data-action="primary">
            ${getPrimaryButtonLabel()}
          </button>
        </div>
      </footer>
    `;

    overlay.appendChild(panel);
    documentRef.body.appendChild(overlay);
    state.modal = overlay;

    // Event listeners
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeModal();
    });

    attachEventListeners();

    return overlay;
  }

  function closeModal() {
    if (state.modal) {
      state.modal.remove();
      state.modal = null;
    }
    // Nettoyer les sortables
    state.sortables.forEach(sortable => {
      try {
        sortable.destroy();
      } catch (e) {}
    });
    state.sortables = [];
  }

  function getStepLabel(step) {
    const labels = {
      1: 'Type',
      2: 'Classes',
      3: 'Config',
      4: 'AperÃ§u',
      5: 'Groupes'
    };
    return labels[step] || '';
  }

  function getFooterInfo() {
    if (state.currentStep === 5 && state.lastGeneration) {
      return `<i class="fas fa-clock"></i> GÃ©nÃ©rÃ© le ${formatDate(state.lastGeneration)}`;
    }
    if (state.selectedClasses.length > 0) {
      return `<i class="fas fa-users"></i> ${state.selectedClasses.length} classe(s) sÃ©lectionnÃ©e(s)`;
    }
    return '<i class="fas fa-info-circle"></i> Suivez les Ã©tapes pour crÃ©er vos groupes';
  }

  function getSecondaryButtonLabel() {
    if (state.currentStep === 1) return 'Fermer';
    if (state.currentStep === 5) return 'Recommencer';
    return 'PrÃ©cÃ©dent';
  }

  function getPrimaryButtonLabel() {
    if (state.currentStep === 4) return 'GÃ©nÃ©rer les groupes';
    if (state.currentStep === 5) return 'Fermer';
    return 'Continuer';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  RENDU DES Ã‰TAPES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function renderStepContent() {
    // ğŸ†• SPRINT #1 : Charger continuation metadata une seule fois au step 1
    if (state.currentStep === 1 && !state.continuationLoaded) {
      state.continuationLoaded = true;
      loadContinuationIfNeeded();
    }

    switch (state.currentStep) {
      case 1: return renderStep1_ChooseType();
      case 2: return renderStep2_SelectClasses();
      case 3: return renderStep3_Configure();
      case 4: return renderStep4_Preview();
      case 5: return renderStep5_Groups();
      default: return '<p class="text-center text-slate-500">Ã‰tape inconnue</p>';
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ã‰TAPE 1 : Choix du type de groupes
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderStep1_ChooseType() {
    return `
      <div class="max-w-5xl mx-auto">
        <div class="text-center mb-10">
          <h3 class="text-3xl font-bold text-slate-900 mb-3">Quel type de groupes souhaitez-vous crÃ©er ?</h3>
          <p class="text-lg text-slate-600">Choisissez le mode de rÃ©partition adaptÃ© Ã  vos besoins pÃ©dagogiques</p>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
          ${Object.values(GROUP_TYPES).map(type => `
            <button
              type="button"
              class="group-type-card ${state.groupType === type.id ? 'selected' : ''} ${type.disabled ? 'disabled' : ''}"
              data-type="${type.id}"
              ${type.disabled ? 'disabled' : ''}
            >
              <div class="icon-wrapper">
                <div class="icon">${type.icon}</div>
              </div>
              <h4 class="title">${type.title}</h4>
              <p class="description">${type.description}</p>
              ${type.disabled ? '<span class="badge-disabled">BientÃ´t disponible</span>' : ''}
              ${state.groupType === type.id ? '<i class="fas fa-check-circle check-icon"></i>' : ''}
            </button>
          `).join('')}
        </div>

        <div class="grid md:grid-cols-2 gap-6 mt-10">
          <div class="info-card ${GROUP_TYPES.needs.bgColor} ${GROUP_TYPES.needs.borderColor}">
            <div class="flex items-start gap-4">
              <div class="text-4xl">${GROUP_TYPES.needs.icon}</div>
              <div>
                <h5 class="font-semibold text-slate-900 mb-2">Groupes de Besoins</h5>
                <ul class="text-sm text-slate-700 space-y-1">
                  <li><i class="fas fa-check text-blue-600 mr-2"></i>Scores Math/FranÃ§ais</li>
                  <li><i class="fas fa-check text-blue-600 mr-2"></i>CritÃ¨res COM, TRA, PART, ABS</li>
                  <li><i class="fas fa-check text-blue-600 mr-2"></i>Groupes hÃ©tÃ©rogÃ¨nes</li>
                  <li><i class="fas fa-check text-blue-600 mr-2"></i>ParitÃ© F/M Ã©quilibrÃ©e</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="info-card ${GROUP_TYPES.language.bgColor} ${GROUP_TYPES.language.borderColor}">
            <div class="flex items-start gap-4">
              <div class="text-4xl">${GROUP_TYPES.language.icon}</div>
              <div>
                <h5 class="font-semibold text-slate-900 mb-2">Groupes LV2</h5>
                <ul class="text-sm text-slate-700 space-y-1">
                  <li><i class="fas fa-check text-purple-600 mr-2"></i>ESP / ITA / autres langues</li>
                  <li><i class="fas fa-check text-purple-600 mr-2"></i>PrioritÃ© Ã  PART (participation)</li>
                  <li><i class="fas fa-check text-purple-600 mr-2"></i>CritÃ¨res COM, TRA, ABS</li>
                  <li><i class="fas fa-check text-purple-600 mr-2"></i>ParitÃ© F/M Ã©quilibrÃ©e</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ã‰TAPE 2 : SÃ©lection des classes
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderStep2_SelectClasses() {
    if (state.isLoading) {
      return `
        <div class="flex flex-col items-center justify-center py-20">
          <div class="spinner-large mb-6"></div>
          <p class="text-lg text-slate-600">Chargement des classes disponibles...</p>
          <p class="text-sm text-slate-500 mt-2">Lecture des onglets avec suffixe FIN</p>
        </div>
      `;
    }

    if (state.loadError) {
      return `
        <div class="flex flex-col items-center justify-center py-20">
          <i class="fas fa-circle-exclamation text-6xl text-red-500 mb-6"></i>
          <p class="text-lg text-red-600 font-semibold mb-2">Erreur de chargement</p>
          <p class="text-sm text-slate-600 mb-6">${state.loadError}</p>
          <button type="button" class="px-6 py-3 rounded-xl bg-red-100 hover:bg-red-200 text-red-700 font-semibold transition-colors" data-action="retry-load">
            <i class="fas fa-rotate-right mr-2"></i>RÃ©essayer
          </button>
        </div>
      `;
    }

    return `
      <div class="max-w-4xl mx-auto">
        <div class="text-center mb-8">
          <h3 class="text-2xl font-bold text-slate-900 mb-3">SÃ©lectionnez les classes Ã  regrouper</h3>
          <p class="text-slate-600">Choisissez les classes qui participeront Ã  la crÃ©ation des groupes</p>
        </div>

        <div class="bg-slate-50 rounded-2xl p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <span class="text-sm font-semibold text-slate-700">
              <i class="fas fa-check-double mr-2"></i>${state.selectedClasses.length} classe(s) sÃ©lectionnÃ©e(s)
            </span>
            <div class="flex gap-2">
              <button type="button" class="px-4 py-2 rounded-lg bg-white hover:bg-slate-100 text-slate-700 text-sm font-medium transition-colors border border-slate-200" data-action="select-all-classes">
                Tout sÃ©lectionner
              </button>
              <button type="button" class="px-4 py-2 rounded-lg bg-white hover:bg-slate-100 text-slate-700 text-sm font-medium transition-colors border border-slate-200" data-action="deselect-all-classes">
                Tout dÃ©sÃ©lectionner
              </button>
            </div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            ${state.availableClasses.length === 0 ? `
              <div class="col-span-full text-center py-8 text-slate-500">
                <i class="fas fa-inbox text-4xl mb-3"></i>
                <p>Aucune classe avec suffixe FIN trouvÃ©e</p>
                <p class="text-sm mt-2">VÃ©rifiez que vos onglets sont nommÃ©s correctement (ex: 6Â°1FIN)</p>
              </div>
            ` : state.availableClasses.map(classe => `
              <label class="class-checkbox-card ${state.selectedClasses.includes(classe) ? 'selected' : ''}">
                <input
                  type="checkbox"
                  class="class-checkbox"
                  value="${classe}"
                  ${state.selectedClasses.includes(classe) ? 'checked' : ''}
                >
                <span class="class-name">${classe}</span>
                <i class="fas fa-check check-icon"></i>
              </label>
            `).join('')}
          </div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-start gap-3">
          <i class="fas fa-lightbulb text-blue-600 text-xl mt-0.5"></i>
          <div class="text-sm text-blue-900">
            <p class="font-semibold mb-1">Conseil :</p>
            <p>Regroupez des classes de mÃªme niveau pour des groupes cohÃ©rents. Exemple : <strong>5Â°1 + 5Â°2 + 5Â°3</strong></p>
          </div>
        </div>
      </div>
    `;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ã‰TAPE 3 : Configuration
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderStep3_Configure() {
    const isNeeds = state.groupType === 'needs';
    const isLanguage = state.groupType === 'language';

    return `
      <div class="max-w-3xl mx-auto">
        <div class="text-center mb-8">
          <h3 class="text-2xl font-bold text-slate-900 mb-3">Configuration des groupes</h3>
          <p class="text-slate-600">DÃ©finissez les paramÃ¨tres de gÃ©nÃ©ration</p>
        </div>

        <div class="config-card mb-6">
          <div class="config-header">
            <i class="fas fa-layer-group text-2xl text-indigo-600"></i>
            <div>
              <h4 class="font-semibold text-slate-900">Nombre de groupes</h4>
              <p class="text-sm text-slate-600">Combien de groupes voulez-vous crÃ©er ?</p>
            </div>
          </div>
          <div class="config-body">
            <div class="flex items-center gap-6">
              <input
                type="range"
                min="1"
                max="10"
                value="${state.numGroups}"
                class="flex-1 accent-indigo-600"
                data-input="numGroups"
              >
              <div class="flex items-center gap-3">
                <button type="button" class="number-btn" data-action="decrement-groups">
                  <i class="fas fa-minus"></i>
                </button>
                <span class="number-display" data-display="numGroups">${state.numGroups}</span>
                <button type="button" class="number-btn" data-action="increment-groups">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        ${isNeeds ? `
          <div class="config-card mb-6">
            <div class="config-header">
              <i class="fas fa-chart-line text-2xl text-blue-600"></i>
              <div>
                <h4 class="font-semibold text-slate-900">MatiÃ¨re de rÃ©fÃ©rence</h4>
                <p class="text-sm text-slate-600">Sur quels scores baser la rÃ©partition ?</p>
              </div>
            </div>
            <div class="config-body">
              <div class="grid grid-cols-1 gap-3">
                ${Object.values(SUBJECTS).map(subject => `
                  <label class="radio-card ${state.selectedSubject === subject.id ? 'selected' : ''}">
                    <input
                      type="radio"
                      name="subject"
                      value="${subject.id}"
                      ${state.selectedSubject === subject.id ? 'checked' : ''}
                    >
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">${subject.icon}</span>
                      <span class="font-medium">${subject.label}</span>
                    </div>
                    <i class="fas fa-check-circle check-icon"></i>
                  </label>
                `).join('')}
              </div>
            </div>
          </div>

          <div class="config-card mb-6">
            <div class="config-header">
              <i class="fas fa-shuffle text-2xl text-purple-600"></i>
              <div>
                <h4 class="font-semibold text-slate-900">Type de rÃ©partition</h4>
                <p class="text-sm text-slate-600">Comment mÃ©langer les niveaux ?</p>
              </div>
            </div>
            <div class="config-body">
              <div class="grid grid-cols-1 gap-3">
                ${Object.values(DISTRIBUTION_TYPES).map(dist => `
                  <label class="radio-card ${state.distributionType === dist.id ? 'selected' : ''}">
                    <input
                      type="radio"
                      name="distribution"
                      value="${dist.id}"
                      ${state.distributionType === dist.id ? 'checked' : ''}
                    >
                    <div class="flex-1">
                      <span class="font-medium">${dist.label}</span>
                      ${dist.recommended ? '<span class="badge-recommended ml-2">RecommandÃ©</span>' : ''}
                    </div>
                    <i class="fas fa-check-circle check-icon"></i>
                  </label>
                `).join('')}
              </div>
            </div>
          </div>
        ` : ''}

        ${isLanguage ? `
          <div class="config-card mb-6">
            <div class="config-header">
              <i class="fas fa-language text-2xl text-purple-600"></i>
              <div>
                <h4 class="font-semibold text-slate-900">Langue Ã  rÃ©partir</h4>
                <p class="text-sm text-slate-600">Quelle LV2 souhaitez-vous regrouper ?</p>
              </div>
            </div>
            <div class="config-body">
              <div class="grid grid-cols-2 gap-3">
                ${['ESP', 'ITA', 'ALL', 'AUTRE'].map(lang => `
                  <label class="radio-card ${state.selectedLanguage === lang ? 'selected' : ''}">
                    <input
                      type="radio"
                      name="language"
                      value="${lang}"
                      ${state.selectedLanguage === lang ? 'checked' : ''}
                    >
                    <div class="flex items-center gap-2">
                      <span class="font-medium">${lang === 'ESP' ? 'Espagnol' : lang === 'ITA' ? 'Italien' : lang === 'ALL' ? 'Allemand' : 'Autre'}</span>
                      ${lang === 'ESP' ? '<span class="text-xl">ğŸ‡ªğŸ‡¸</span>' : lang === 'ITA' ? '<span class="text-xl">ğŸ‡®ğŸ‡¹</span>' : lang === 'ALL' ? '<span class="text-xl">ğŸ‡©ğŸ‡ª</span>' : '<span class="text-xl">ğŸŒ</span>'}
                    </div>
                    <i class="fas fa-check-circle check-icon"></i>
                  </label>
                `).join('')}
              </div>
            </div>
          </div>

          <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 flex items-start gap-3">
            <i class="fas fa-info-circle text-purple-600 text-xl mt-0.5"></i>
            <div class="text-sm text-purple-900">
              <p class="font-semibold mb-1">Ã€ propos de la langue :</p>
              <p>Les Ã©lÃ¨ves de la langue sÃ©lectionnÃ©e seront rÃ©partis en <strong>${state.numGroups} groupe(s)</strong>. La <strong>participation (PART)</strong> sera le critÃ¨re prioritaire.</p>
            </div>
          </div>
        ` : ''}
      </div>
    `;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ã‰TAPE 4 : AperÃ§u avant gÃ©nÃ©ration
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderStep4_Preview() {
    const config = getConfigSummary();

    return `
      <div class="max-w-4xl mx-auto">
        <div class="text-center mb-8">
          <h3 class="text-2xl font-bold text-slate-900 mb-3">RÃ©capitulatif de la configuration</h3>
          <p class="text-slate-600">VÃ©rifiez les paramÃ¨tres avant de gÃ©nÃ©rer les groupes</p>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mb-8">
          <div class="summary-card">
            <div class="summary-icon ${GROUP_TYPES[state.groupType].color}">
              ${GROUP_TYPES[state.groupType].icon}
            </div>
            <div>
              <p class="summary-label">Type de groupes</p>
              <p class="summary-value">${GROUP_TYPES[state.groupType].title}</p>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-icon bg-gradient-to-br from-indigo-600 to-purple-600">
              <i class="fas fa-layer-group"></i>
            </div>
            <div>
              <p class="summary-label">Nombre de groupes</p>
              <p class="summary-value">${state.numGroups} groupe(s)</p>
            </div>
          </div>

          <div class="summary-card md:col-span-2">
            <div class="summary-icon bg-gradient-to-br from-emerald-600 to-teal-600">
              <i class="fas fa-school"></i>
            </div>
            <div class="flex-1">
              <p class="summary-label">Classes sÃ©lectionnÃ©es</p>
              <p class="summary-value">${state.selectedClasses.length} classe(s)</p>
              <div class="flex flex-wrap gap-2 mt-2">
                ${state.selectedClasses.map(c => `
                  <span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium">${c}</span>
                `).join('')}
              </div>
            </div>
          </div>

          ${config.map(item => `
            <div class="summary-card">
              <div class="summary-icon ${item.color}">
                <i class="fas ${item.icon}"></i>
              </div>
              <div>
                <p class="summary-label">${item.label}</p>
                <p class="summary-value">${item.value}</p>
              </div>
            </div>
          `).join('')}
        </div>

        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl p-6 border border-slate-200">
          <h4 class="font-semibold text-slate-900 mb-4 flex items-center gap-2">
            <i class="fas fa-list-check text-indigo-600"></i>
            CritÃ¨res de rÃ©partition appliquÃ©s
          </h4>
          <div class="grid md:grid-cols-2 gap-3">
            ${getCriteriaList().map(criterion => `
              <div class="flex items-center gap-2 text-sm text-slate-700">
                <i class="fas fa-check-circle text-green-600"></i>
                <span>${criterion}</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="mt-6 bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-3">
          <i class="fas fa-triangle-exclamation text-amber-600 text-xl mt-0.5"></i>
          <div class="text-sm text-amber-900">
            <p class="font-semibold mb-1">Attention :</p>
            <p>La gÃ©nÃ©ration peut prendre quelques secondes selon le nombre d'Ã©lÃ¨ves. L'algorithme optimise la rÃ©partition pour respecter tous les critÃ¨res.</p>
          </div>
        </div>
      </div>
    `;
  }

  function getConfigSummary() {
    const items = [];

    if (state.groupType === 'needs') {
      items.push({
        label: 'MatiÃ¨re de rÃ©fÃ©rence',
        value: SUBJECTS[state.selectedSubject].label,
        icon: 'fa-chart-line',
        color: 'bg-gradient-to-br from-blue-600 to-indigo-600'
      });
      items.push({
        label: 'Type de rÃ©partition',
        value: DISTRIBUTION_TYPES[state.distributionType].label,
        icon: 'fa-shuffle',
        color: 'bg-gradient-to-br from-purple-600 to-pink-600'
      });
    }

    if (state.groupType === 'language') {
      const langLabels = { ESP: 'Espagnol', ITA: 'Italien', ALL: 'Allemand', AUTRE: 'Autre' };
      items.push({
        label: 'Langue ciblÃ©e',
        value: langLabels[state.selectedLanguage] || state.selectedLanguage,
        icon: 'fa-language',
        color: 'bg-gradient-to-br from-purple-600 to-pink-600'
      });
    }

    return items;
  }

  function getCriteriaList() {
    const base = [
      'ParitÃ© Filles/GarÃ§ons Ã©quilibrÃ©e',
      'Effectifs harmonisÃ©s (Â±1-2 Ã©lÃ¨ves)',
      'CritÃ¨res COM, TRA, PART, ABS'
    ];

    if (state.groupType === 'needs') {
      return [
        'Scores Math/FranÃ§ais (groupes hÃ©tÃ©rogÃ¨nes)',
        ...base,
        'Tous niveaux mÃ©langÃ©s dans chaque groupe'
      ];
    }

    if (state.groupType === 'language') {
      return [
        'Participation (PART) - CritÃ¨re prioritaire',
        ...base,
        'RÃ©partition Ã©quilibrÃ©e par langue'
      ];
    }

    return base;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  Ã‰TAPE 5 : Affichage des groupes avec Drag & Drop
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderStep5_Groups() {
    if (state.isLoading) {
      return `
        <div class="flex flex-col items-center justify-center py-20">
          <div class="spinner-large mb-6"></div>
          <p class="text-lg text-slate-600 font-semibold">GÃ©nÃ©ration des groupes en cours...</p>
          <p class="text-sm text-slate-500 mt-2">L'algorithme optimise la rÃ©partition</p>
          <div class="mt-6 flex items-center gap-2 text-xs text-slate-400">
            <div class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>
            <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse delay-100"></div>
            <div class="w-2 h-2 bg-pink-500 rounded-full animate-pulse delay-200"></div>
          </div>
        </div>
      `;
    }

    if (!state.generatedGroups || state.generatedGroups.length === 0) {
      return `
        <div class="flex flex-col items-center justify-center py-20">
          <i class="fas fa-inbox text-6xl text-slate-300 mb-6"></i>
          <p class="text-lg text-slate-600">Aucun groupe gÃ©nÃ©rÃ©</p>
          <button type="button" class="mt-6 px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition-colors" data-action="regenerate">
            <i class="fas fa-rotate-right mr-2"></i>GÃ©nÃ©rer maintenant
          </button>
        </div>
      `;
    }

    // LAYOUT : Adapter le nombre de colonnes selon le nombre de groupes
    // Objectif : maximiser la HAUTEUR verticale de chaque groupe pour plus de swaps
    // - 1-3 groupes : autant de colonnes (cÃ´te Ã  cÃ´te)
    // - 4 groupes : 2 colonnes (2x2 grid)
    // - 5-6 groupes : 3 colonnes (max) pour garder hauteur
    // - 7+ groupes : 3 colonnes + scroll horizontal
    const groupCount = state.generatedGroups.length;
    let gridClass = '';

    if (groupCount <= 3) {
      gridClass = `grid-cols-${groupCount}`; // 1, 2 ou 3 colonnes selon le nombre
    } else if (groupCount === 4) {
      gridClass = 'grid-cols-2'; // 2x2 grid
    } else if (groupCount <= 6) {
      gridClass = 'grid-cols-3'; // 3 colonnes max pour garder hauteur
    } else {
      gridClass = 'grid-cols-3'; // 3 colonnes + scroll pour 7+
    }

    return `
      <div class="flex flex-col h-full">
        <!-- BANDEAU MODE CONTINUATION -->
        ${state.persistMode && state.lastTempRange ? `
          <div class="flex-shrink-0 mb-6 bg-blue-100 border-l-4 border-blue-600 p-4 rounded">
            <p class="text-blue-900 font-bold text-lg">
              ğŸ”„ MODE CONTINUATION ACTIF
            </p>
            <p class="text-blue-800 text-sm mt-1">
              Groupes prÃ©cÃ©dents: ${state.lastTempRange.typePrefix}${state.lastTempRange.min} â†’ ${state.lastTempRange.typePrefix}${state.lastTempRange.max}
            </p>
            <p class="text-blue-700 text-sm font-semibold mt-2">
              âœ¨ Prochains groupes: ${state.tempOffsetStart} â†’ ${state.tempOffsetStart + state.generatedGroups.length - 1}
            </p>
          </div>
        ` : ''}

        <div class="flex-shrink-0 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-2xl font-bold text-slate-900">Groupes gÃ©nÃ©rÃ©s</h3>
              <p class="text-sm text-slate-600 mt-1">
                ${state.generatedGroups.length} groupe(s) â€¢ ${getTotalStudents()} Ã©lÃ¨ves rÃ©partis
              </p>
            </div>
            <div class="flex items-center gap-3 flex-wrap justify-end">
              <!-- Mode de sauvegarde: Remplacer ou Ajouter -->
              <div class="flex items-center gap-2 bg-slate-100 p-2 rounded-lg">
                <button type="button" class="action-btn ${state.saveMode === 'replace' ? 'bg-red-600 text-white' : 'bg-slate-200 text-slate-700'}" data-action="set-save-mode" data-mode="replace" title="Remplacer: supprime les groupes prÃ©cÃ©dents du mÃªme type">
                  <i class="fas fa-arrows-rotate"></i>
                  Remplacer
                </button>
                <button type="button" class="action-btn ${state.saveMode === 'append' ? 'bg-green-600 text-white' : 'bg-slate-200 text-slate-700'}" data-action="set-save-mode" data-mode="append" title="Ajouter: cumule avec les groupes existants">
                  <i class="fas fa-plus-circle"></i>
                  Ajouter
                </button>
              </div>

              <button type="button" class="action-btn ${state.showStatistics ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-700'} hover:bg-indigo-700" data-action="toggle-statistics">
                <i class="fas fa-chart-bar"></i>
                Statistiques
              </button>
              <button type="button" class="action-btn bg-slate-100 hover:bg-slate-200 text-slate-700" data-action="regenerate">
                <i class="fas fa-rotate-right"></i>
                RÃ©gÃ©nÃ©rer
              </button>
              <button type="button" class="action-btn bg-blue-100 hover:bg-blue-200 text-blue-700" data-action="export-pdf">
                <i class="fas fa-file-pdf"></i>
                PDF
              </button>
              <button type="button" class="action-btn bg-green-100 hover:bg-green-200 text-green-700" data-action="export-csv">
                <i class="fas fa-file-csv"></i>
                CSV
              </button>
              <button type="button" class="action-btn bg-yellow-100 hover:bg-yellow-200 text-yellow-700" data-action="load-temp-groups" title="Charger les groupes temporaires sauvegardÃ©s">
                <i class="fas fa-download"></i>
                ğŸ“¥ Charger
              </button>
              <button type="button" class="action-btn bg-purple-100 hover:bg-purple-200 text-purple-700" data-action="show-snapshots" title="Voir l'historique et restaurer une version antÃ©rieure">
                <i class="fas fa-history"></i>
                ğŸ“¸ Snapshots
              </button>
              <button type="button" class="action-btn bg-cyan-100 hover:bg-cyan-200 text-cyan-700" data-action="show-audit-history" title="Voir l'historique complet des opÃ©rations d'audit">
                <i class="fas fa-list"></i>
                ğŸ“‹ Historique
              </button>
              <button type="button" class="action-btn bg-orange-600 hover:bg-orange-700 text-white" data-action="save-temp-groups" title="Sauvegarder les groupes en version temporaire (cachÃ©e)">
                <i class="fas fa-save"></i>
                ğŸ’¾ Temp
              </button>
              <button type="button" class="action-btn bg-green-600 hover:bg-green-700 text-white" data-action="finalize-temp-groups" title="Finaliser : convertir gr*TEMP en gr* (visibles)">
                <i class="fas fa-check-circle"></i>
                âœ… Finaliser
              </button>
            </div>
          </div>
        </div>

        <!-- Contenu flexible et scrollable -->
        <div class="flex-1 overflow-y-auto">
          ${state.showStatistics ? `
            <div class="flex gap-6 h-full">
              <!-- Groupes: flex-shrink-0 pour Ã©viter l'Ã©crasement -->
              <div class="flex-shrink-0 overflow-y-auto" style="min-width: 50%;">
                <div class="grid ${gridClass} gap-4 pr-4" id="groups-container">
                  ${state.generatedGroups.map((group, index) => renderGroupCard(group, index)).join('')}
                </div>
              </div>

              <!-- Stats: flex-1 pour prendre l'espace restant -->
              <div class="flex-1 overflow-y-auto border-l border-slate-200 pl-6">
                ${renderStatisticsPanel()}
              </div>
            </div>
          ` : `
            <div class="grid ${gridClass} gap-4" id="groups-container">
              ${state.generatedGroups.map((group, index) => renderGroupCard(group, index)).join('')}
            </div>
          `}
        </div>

        <!-- Info fixe en bas -->
        <div class="flex-shrink-0 mt-6 bg-indigo-50 border border-indigo-200 rounded-xl p-4 flex items-start gap-3">
          <i class="fas fa-hand-pointer text-indigo-600 text-xl mt-0.5"></i>
          <div class="text-sm text-indigo-900">
            <p class="font-semibold mb-1">Glisser-dÃ©poser activÃ© :</p>
            <p>Vous pouvez rÃ©organiser les Ã©lÃ¨ves en les dÃ©plaÃ§ant d'un groupe Ã  l'autre. Les statistiques se mettent Ã  jour automatiquement.</p>
          </div>
        </div>
      </div>
    `;
  }

  function renderGroupCard(group, index) {
    const stats = calculateGroupStats(group);

    // Afficher le vrai numÃ©ro du groupe (en tenant compte de l'offset)
    const groupNumber = state.tempOffsetStart + index;
    const groupLabel = group.name || `Groupe ${groupNumber}`;

    return `
      <div class="group-card" data-group-index="${index}">
        <div class="group-header ${GROUP_TYPES[state.groupType].color}">
          <h4 class="group-title">${groupLabel}</h4>
          <span class="group-count">${group.students.length} Ã©lÃ¨ves</span>
        </div>

        <div class="group-stats">
          <div class="stat-item">
            <i class="fas fa-venus-mars text-pink-600"></i>
            <span>${stats.girls}F / ${stats.boys}M</span>
          </div>
          ${state.groupType === 'needs' ? `
            <div class="stat-item">
              <i class="fas fa-chart-line text-blue-600"></i>
              <span>Moy: ${stats.avgScore}</span>
            </div>
          ` : ''}
          ${state.groupType === 'language' ? `
            <div class="stat-item">
              <i class="fas fa-comments text-purple-600"></i>
              <span>PART: ${stats.avgPart}</span>
            </div>
          ` : ''}
        </div>

        <div class="group-students" data-group-id="${index}">
          ${group.students.map(student => renderStudentCard(student)).join('')}
        </div>
      </div>
    `;
  }

  function renderStudentCard(student) {
    const nomAffiche = simplifierNomComplet(student.nom, student.prenom);

    // DÃ©terminer si l'Ã©lÃ¨ve a un score COM = 1 (besoin d'attention)
    const comScore = student.scores?.COM ?? student.com ?? 0;
    const isComRed = comScore === 1;
    const nameClass = isComRed ? 'text-red-600 font-semibold' : '';

    return `
      <div class="student-card" data-student-id="${student.id}" data-source="${student.source || ''}">
        <span class="student-sexe ${student.sexe === 'F' ? 'sexe-f' : 'sexe-m'}" title="${student.sexe}">${student.sexe || '?'}</span>
        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 0.125rem;">
          <p class="student-name ${nameClass}" title="${nomAffiche}">${nomAffiche}</p>
          <div style="display: flex; gap: 0.25rem; font-size: 0.65rem; color: #64748b;">
            <span title="Classe FIN">${student.classe || 'â€”'}</span>
            ${student.source ? `<span title="Classe origine">| ${student.source}</span>` : ''}
          </div>
        </div>
        ${renderStudentScores(student)}
        <i class="fas fa-grip-vertical text-slate-300 drag-handle" style="flex-shrink: 0; font-size: 0.7rem;"></i>
      </div>
    `;
  }

  function renderStudentScores(student) {
    if (state.groupType === 'needs') {
      const scoreF = student.scores?.F || 0;
      const scoreM = student.scores?.M || 0;
      const avg = ((scoreF + scoreM) / 2).toFixed(1);
      return `
        <div class="student-scores">
          <span class="score-badge">ğŸ“š ${scoreF}</span>
          <span class="score-badge">ğŸ“ ${scoreM}</span>
          <span class="score-badge avg">Moy ${avg}</span>
        </div>
      `;
    }

    if (state.groupType === 'language') {
      const part = student.part || student.scores?.PART || 0;
      return `
        <div class="student-scores">
          <span class="score-badge">${student.lv2 || 'â€”'}</span>
          <span class="score-badge">PART: ${part}</span>
        </div>
      `;
    }

    return '';
  }

  function calculateGroupStats(group) {
    let girls = 0, boys = 0, totalScoreF = 0, totalScoreM = 0, totalPart = 0;

    group.students.forEach(student => {
      if (student.sexe === 'F') girls++;
      if (student.sexe === 'M') boys++;
      totalScoreF += student.scores?.F || 2.5;
      totalScoreM += student.scores?.M || 2.5;
      totalPart += student.part || student.scores?.PART || 0;
    });

    const count = group.students.length || 1;

    return {
      girls,
      boys,
      avgScore: ((totalScoreF + totalScoreM) / (count * 2)).toFixed(1),
      avgPart: (totalPart / count).toFixed(1)
    };
  }

  function getTotalStudents() {
    return state.generatedGroups.reduce((sum, group) => sum + group.students.length, 0);
  }

  function getGroupPrefix() {
    const prefixes = {
      'needs': 'grBe',
      'language': 'grLV',
      'option': 'grOpt'
    };
    return prefixes[state.groupType] || 'gr';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  PANNEAU STATISTIQUES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function renderStatisticsPanel() {
    return `
      <div class="statistics-panel w-96">
        <div class="bg-white rounded-2xl border-2 border-slate-200 overflow-hidden sticky top-4">
          <div class="bg-gradient-to-br from-indigo-600 to-purple-600 text-white p-4">
            <h4 class="font-bold text-lg flex items-center gap-2">
              <i class="fas fa-chart-pie"></i>
              Distribution des scores
            </h4>
            <p class="text-sm opacity-90 mt-1">Analyse par groupe</p>
          </div>

          <div class="max-h-[calc(100vh-240px)] overflow-y-auto p-4">
            ${state.generatedGroups.map((group, index) => renderGroupStatistics(group, index)).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderGroupStatistics(group, index) {
    const stats = calculateGroupStats(group);
    const scoreDistribution = calculateScoreDistribution(group);

    return `
      <div class="mb-4 last:mb-0">
        <div class="bg-slate-50 rounded-xl p-3 border border-slate-200">
          <div class="flex items-center justify-between mb-3">
            <h5 class="font-semibold text-slate-900">${group.name || `Groupe ${index + 1}`}</h5>
            <span class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-full font-medium">${group.students.length}</span>
          </div>

          <div class="mb-3 pb-3 border-b border-slate-200">
            <div class="flex items-center justify-between text-sm">
              <span class="text-slate-600">ParitÃ©</span>
              <span class="font-semibold text-slate-900">${stats.girls}F / ${stats.boys}M</span>
            </div>
          </div>

          ${state.groupType === 'needs' ? `
            <div class="space-y-2">
              <div class="text-xs font-semibold text-slate-700 uppercase tracking-wide mb-2">Distribution FranÃ§ais</div>
              ${renderScoreDistributionBars(scoreDistribution.F, 'F')}

              <div class="text-xs font-semibold text-slate-700 uppercase tracking-wide mb-2 mt-3">Distribution Maths</div>
              ${renderScoreDistributionBars(scoreDistribution.M, 'M')}

              <div class="mt-3 pt-3 border-t border-slate-200">
                <div class="text-xs font-semibold text-slate-700 uppercase tracking-wide mb-2">CritÃ¨res</div>
                ${renderBehavioralCriteria(group)}
              </div>
            </div>
          ` : ''}

          ${state.groupType === 'language' ? `
            <div class="space-y-2">
              <div class="flex items-center justify-between text-sm">
                <span class="text-slate-600">Participation moy.</span>
                <span class="font-semibold text-purple-700">${stats.avgPart}</span>
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  function calculateScoreDistribution(group) {
    const distribution = {
      F: { 1: 0, 2: 0, 3: 0, 4: 0 },
      M: { 1: 0, 2: 0, 3: 0, 4: 0 }
    };

    group.students.forEach(student => {
      const scoreF = Math.round(student.scores?.F || 2.5);
      const scoreM = Math.round(student.scores?.M || 2.5);

      // Clamp scores entre 1 et 4
      const clampedF = Math.max(1, Math.min(4, scoreF));
      const clampedM = Math.max(1, Math.min(4, scoreM));

      distribution.F[clampedF] = (distribution.F[clampedF] || 0) + 1;
      distribution.M[clampedM] = (distribution.M[clampedM] || 0) + 1;
    });

    return distribution;
  }

  function renderScoreDistributionBars(distribution, subject) {
    const total = Object.values(distribution).reduce((a, b) => a + b, 0) || 1;
    const colors = {
      1: 'bg-red-500',
      2: 'bg-yellow-500',
      3: 'bg-green-400',
      4: 'bg-green-700'
    };

    return `
      <div class="space-y-1.5">
        ${[1, 2, 3, 4].map(score => {
          const count = distribution[score] || 0;
          const percentage = Math.round((count / total) * 100);

          return `
            <div class="flex items-center gap-2">
              <span class="text-xs font-medium text-slate-600 w-8">${subject === 'F' ? 'ğŸ“š' : 'ğŸ“'} ${score}</span>
              <div class="flex-1 bg-slate-200 rounded-full h-5 overflow-hidden">
                <div class="${colors[score]} h-full flex items-center justify-end pr-2 transition-all" style="width: ${percentage}%">
                  ${count > 0 ? `<span class="text-xs font-bold text-white">${count}</span>` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  function renderBehavioralCriteria(group) {
    let totalCOM = 0, totalTRA = 0, totalPART = 0, totalABS = 0;
    const count = group.students.length || 1;

    group.students.forEach(student => {
      totalCOM += student.com || 0;
      totalTRA += student.tra || 0;
      totalPART += student.part || 0;
      totalABS += student.abs || 0;
    });

    const avgCOM = (totalCOM / count).toFixed(1);
    const avgTRA = (totalTRA / count).toFixed(1);
    const avgPART = (totalPART / count).toFixed(1);
    const avgABS = (totalABS / count).toFixed(1);

    return `
      <div class="space-y-1.5 text-xs">
        <div class="flex items-center justify-between">
          <span class="text-slate-600">COM (Comportement)</span>
          <span class="font-semibold text-blue-700">${avgCOM}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-slate-600">TRA (Travail)</span>
          <span class="font-semibold text-indigo-700">${avgTRA}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-slate-600">PART (Participation)</span>
          <span class="font-semibold text-purple-700">${avgPART}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-slate-600">ABS (Absences)</span>
          <span class="font-semibold text-pink-700">${avgABS}</span>
        </div>
      </div>
    `;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SPRINT #3 : STATISTIQUES & DASHBOARD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Calcule les statistiques complÃ¨tes des groupes gÃ©nÃ©rÃ©s
   * Retourne : {byGroup: [...], global: {...}, alerts: [...]}
   */
  function calculateStatistics() {
    if (!Array.isArray(state.generatedGroups) || state.generatedGroups.length === 0) {
      return { byGroup: [], global: {}, alerts: [] };
    }

    const stats = {
      byGroup: [],
      global: {}
    };

    // ğŸ”¢ STATS PAR GROUPE
    state.generatedGroups.forEach((group, idx) => {
      const students = group.students || [];
      const count = students.length;

      // Scores
      const scores = students.map(s => {
        const needScore = getNeedScoreForStudent(s);
        return Number.isFinite(needScore) ? needScore : 0;
      });
      const avgScore = count > 0 ? scores.reduce((a, b) => a + b, 0) / count : 0;
      const scoreStdDev = count > 1
        ? Math.sqrt(scores.reduce((sum, s) => sum + Math.pow(s - avgScore, 2), 0) / count)
        : 0;

      // ParitÃ© F/M
      const girls = students.filter(s => (s.sexe || '').toUpperCase() === 'F').length;
      const boys = students.filter(s => (s.sexe || '').toUpperCase() === 'M').length;

      // Comportements
      const comScores = students.map(s => Number(s.com ?? 0));
      const avgCOM = count > 0 ? comScores.reduce((a, b) => a + b, 0) / count : 0;

      const traScores = students.map(s => Number(s.tra ?? 0));
      const avgTRA = count > 0 ? traScores.reduce((a, b) => a + b, 0) / count : 0;

      const partScores = students.map(s => Number(s.part ?? 0));
      const avgPART = count > 0 ? partScores.reduce((a, b) => a + b, 0) / count : 0;

      const absScores = students.map(s => Number(s.abs ?? 0));
      const avgABS = count > 0 ? absScores.reduce((a, b) => a + b, 0) / count : 0;

      // Source (classe d'origine)
      const sources = {};
      students.forEach(s => {
        const src = s.source || 'Inconnu';
        sources[src] = (sources[src] || 0) + 1;
      });

      stats.byGroup.push({
        idx: idx,
        name: `Groupe ${state.tempOffsetStart + idx}`,
        count: count,
        avgScore: parseFloat(avgScore.toFixed(2)),
        scoreStdDev: parseFloat(scoreStdDev.toFixed(2)),
        girls: girls,
        boys: boys,
        parityRatio: count > 0 ? (girls / count * 100).toFixed(1) + '%' : '0%',
        avgCOM: parseFloat(avgCOM.toFixed(2)),
        avgTRA: parseFloat(avgTRA.toFixed(2)),
        avgPART: parseFloat(avgPART.toFixed(2)),
        avgABS: parseFloat(avgABS.toFixed(2)),
        sources: sources
      });
    });

    // ğŸŒ STATS GLOBALES
    const sizes = stats.byGroup.map(g => g.count);
    const avgScores = stats.byGroup.map(g => g.avgScore);
    const allGirls = stats.byGroup.reduce((s, g) => s + g.girls, 0);
    const allBoys = stats.byGroup.reduce((s, g) => s + g.boys, 0);

    const meanSize = sizes.reduce((a, b) => a + b, 0) / sizes.length;
    const meanScore = avgScores.reduce((a, b) => a + b, 0) / avgScores.length;

    stats.global.totalStudents = sizes.reduce((a, b) => a + b, 0);
    stats.global.numGroups = state.generatedGroups.length;
    stats.global.avgGroupSize = parseFloat(meanSize.toFixed(2));
    stats.global.sizeStdDev = Math.sqrt(sizes.reduce((sum, s) => sum + Math.pow(s - meanSize, 2), 0) / sizes.length);
    stats.global.sizeStdDev = parseFloat(stats.global.sizeStdDev.toFixed(2));

    stats.global.avgScore = parseFloat(meanScore.toFixed(2));
    stats.global.scoreStdDev = Math.sqrt(avgScores.reduce((sum, s) => sum + Math.pow(s - meanScore, 2), 0) / avgScores.length);
    stats.global.scoreStdDev = parseFloat(stats.global.scoreStdDev.toFixed(2));

    stats.global.totalGirls = allGirls;
    stats.global.totalBoys = allBoys;
    stats.global.globalParityPercent = allGirls + allBoys > 0 ? (allGirls / (allGirls + allBoys) * 100).toFixed(1) : '0';

    // ğŸš¨ ALERTES
    stats.alerts = [];

    // Alerte 1 : Ã‰cart de taille trop grand
    if (stats.global.sizeStdDev > 2) {
      stats.alerts.push({
        level: 'warning',
        icon: 'âš ï¸',
        message: `Groupes dÃ©sÃ©quilibrÃ©s en taille (Ã©cart-type: ${stats.global.sizeStdDev}). Max Ã©cart: ${Math.max(...sizes) - Math.min(...sizes)} Ã©lÃ¨ves`
      });
    }

    // Alerte 2 : Ã‰cart de score trop grand
    if (stats.global.scoreStdDev > 1.5) {
      stats.alerts.push({
        level: 'warning',
        icon: 'ğŸ“Š',
        message: `Groupes dÃ©sÃ©quilibrÃ©s en niveau acadÃ©mique (Ã©cart-type: ${stats.global.scoreStdDev}). Ã‰cart score moyen: ${(Math.max(...avgScores) - Math.min(...avgScores)).toFixed(2)}`
      });
    }

    // Alerte 3 : ParitÃ© dÃ©sÃ©quilibrÃ©e
    const parityDiff = Math.abs(allGirls - allBoys);
    if (parityDiff > 5) {
      stats.alerts.push({
        level: 'warning',
        icon: 'ğŸ‘¥',
        message: `ParitÃ© F/M dÃ©sÃ©quilibrÃ©e (${allGirls}F / ${allBoys}M, Ã©cart: ${parityDiff})`
      });
    }

    // Alerte 4 : Un groupe avec beaucoup plus de filles/garÃ§ons
    stats.byGroup.forEach(g => {
      if (g.count > 0) {
        const parityPercent = (g.girls / g.count) * 100;
        if (parityPercent < 30 || parityPercent > 70) {
          stats.alerts.push({
            level: 'info',
            icon: 'ğŸ‘¤',
            message: `${g.name} : paritÃ© ${(100 - parityPercent).toFixed(0)}M / ${parityPercent.toFixed(0)}F (dÃ©sÃ©quilibrÃ©)`
          });
        }
      }
    });

    // Alerte 5 : Comportement trÃ¨s dÃ©gradÃ©
    const avgGlobalCOM = stats.byGroup.reduce((s, g) => s + g.avgCOM, 0) / stats.byGroup.length;
    const avgGlobalABS = stats.byGroup.reduce((s, g) => s + g.avgABS, 0) / stats.byGroup.length;
    if (avgGlobalCOM < 2) {
      stats.alerts.push({
        level: 'info',
        icon: 'âš ï¸',
        message: `Comportement moyen trÃ¨s bas (${avgGlobalCOM.toFixed(2)}/5). VÃ©rifiez les donnÃ©es`
      });
    }

    console.log('[GroupsModule] ğŸ“Š Stats calculÃ©es:', stats);
    return stats;
  }

  /**
   * Affiche le dashboard de statistiques
   */
  function renderStatisticsPanel() {
    const stats = calculateStatistics();

    if (stats.byGroup.length === 0) {
      return `
        <div class="p-6 bg-amber-50 border border-amber-200 rounded-lg">
          <p class="text-amber-900 font-semibold">ğŸ“Š Pas de groupes gÃ©nÃ©rÃ©s encore</p>
          <p class="text-amber-800 text-sm mt-2">GÃ©nÃ©rez les groupes d'abord pour voir les statistiques</p>
        </div>
      `;
    }

    return `
      <div class="space-y-6">
        <!-- MÃ‰TRIQUES GLOBALES -->
        <div class="grid md:grid-cols-4 gap-4">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-700 font-semibold">Total Ã‰lÃ¨ves</p>
            <p class="text-2xl font-bold text-blue-900">${stats.global.totalStudents}</p>
            <p class="text-xs text-blue-600 mt-1">dans ${stats.global.numGroups} groupes</p>
          </div>

          <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <p class="text-sm text-purple-700 font-semibold">Taille Moyenne</p>
            <p class="text-2xl font-bold text-purple-900">${stats.global.avgGroupSize}</p>
            <p class="text-xs text-purple-600 mt-1">Ïƒ: ${stats.global.sizeStdDev}</p>
          </div>

          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <p class="text-sm text-green-700 font-semibold">Niveau Moyen</p>
            <p class="text-2xl font-bold text-green-900">${stats.global.avgScore}</p>
            <p class="text-xs text-green-600 mt-1">Ïƒ: ${stats.global.scoreStdDev}</p>
          </div>

          <div class="bg-pink-50 border border-pink-200 rounded-lg p-4">
            <p class="text-sm text-pink-700 font-semibold">ParitÃ©</p>
            <p class="text-2xl font-bold text-pink-900">${stats.global.globalParityPercent}%</p>
            <p class="text-xs text-pink-600 mt-1">${stats.global.totalGirls}F / ${stats.global.totalBoys}M</p>
          </div>
        </div>

        <!-- ALERTES -->
        ${stats.alerts.length > 0 ? `
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="font-semibold text-yellow-900 mb-3">ğŸš¨ Alertes DÃ©tectÃ©es</h4>
            <div class="space-y-2">
              ${stats.alerts.map(alert => `
                <div class="flex items-start gap-2 p-2 bg-white rounded">
                  <span class="text-lg flex-shrink-0">${alert.icon}</span>
                  <p class="text-sm text-yellow-900">${alert.message}</p>
                </div>
              `).join('')}
            </div>
          </div>
        ` : `
          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <p class="text-green-900 font-semibold">âœ… Tous les indicateurs sont Ã©quilibrÃ©s!</p>
          </div>
        `}

        <!-- TABLEAU DÃ‰TAILLÃ‰ PAR GROUPE -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm border-collapse">
            <thead class="bg-slate-100 border-b-2 border-slate-300">
              <tr>
                <th class="px-3 py-2 text-left font-semibold text-slate-900">Groupe</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-900">Effectif</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-900">Niveau Moy</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-900">Ã‰cart-type</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-900">ParitÃ© F/M</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-900">COM</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-900">TRA</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-900">PART</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-900">ABS</th>
              </tr>
            </thead>
            <tbody>
              ${stats.byGroup.map(g => `
                <tr class="border-b border-slate-200 hover:bg-slate-50">
                  <td class="px-3 py-2 font-semibold text-slate-900">${g.name}</td>
                  <td class="px-3 py-2 text-center text-slate-700">${g.count}</td>
                  <td class="px-3 py-2 text-center text-slate-700">${g.avgScore}</td>
                  <td class="px-3 py-2 text-center text-slate-600">Â±${g.scoreStdDev}</td>
                  <td class="px-3 py-2 text-center text-slate-700">${g.girls}/${g.boys}</td>
                  <td class="px-3 py-2 text-center ${g.avgCOM < 2 ? 'text-red-700 font-semibold' : 'text-slate-700'}">${g.avgCOM}</td>
                  <td class="px-3 py-2 text-center text-slate-700">${g.avgTRA}</td>
                  <td class="px-3 py-2 text-center text-slate-700">${g.avgPART}</td>
                  <td class="px-3 py-2 text-center ${g.avgABS > 2 ? 'text-red-700 font-semibold' : 'text-slate-700'}">${g.avgABS}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <!-- BOUTON RÃ‰GÃ‰NÃ‰RER -->
        <div class="flex gap-3 justify-center">
          <button
            type="button"
            class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
            onclick="generateGroups()"
          >
            ğŸ”„ RÃ©gÃ©nÃ©rer les Groupes
          </button>
          <button
            type="button"
            class="px-6 py-2 bg-slate-400 text-white font-semibold rounded-lg hover:bg-slate-500 transition-colors"
            onclick="toggleStatistics()"
          >
            âœ• Fermer Stats
          </button>
        </div>
      </div>
    `;
  }

  function toggleStatistics() {
    state.showStatistics = !state.showStatistics;
    updateUI();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  NAVIGATION & EVENT LISTENERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function attachEventListeners() {
    if (!state.modal) return;

    // Actions principales
    const primaryBtn = qs('[data-action="primary"]', state.modal);
    const secondaryBtn = qs('[data-action="secondary"]', state.modal);
    const closeBtn = qs('[data-action="close"]', state.modal);

    if (primaryBtn) primaryBtn.onclick = handlePrimaryAction;
    if (secondaryBtn) secondaryBtn.onclick = handleSecondaryAction;
    if (closeBtn) closeBtn.onclick = closeModal;

    // Ã‰tape 1 : SÃ©lection du type
    qsa('[data-type]', state.modal).forEach(btn => {
      btn.onclick = () => {
        if (!btn.disabled) {
          selectGroupType(btn.dataset.type);
        }
      };
    });

    // Ã‰tape 2 : SÃ©lection des classes
    qsa('.class-checkbox', state.modal).forEach(checkbox => {
      checkbox.onchange = handleClassSelection;
    });

    const selectAllBtn = qs('[data-action="select-all-classes"]', state.modal);
    const deselectAllBtn = qs('[data-action="deselect-all-classes"]', state.modal);
    const retryBtn = qs('[data-action="retry-load"]', state.modal);

    if (selectAllBtn) selectAllBtn.onclick = selectAllClasses;
    if (deselectAllBtn) deselectAllBtn.onclick = deselectAllClasses;
    if (retryBtn) retryBtn.onclick = loadAvailableClasses;

    // Ã‰tape 3 : Configuration
    const numGroupsRange = qs('[data-input="numGroups"]', state.modal);
    if (numGroupsRange) {
      numGroupsRange.oninput = (e) => {
        state.numGroups = parseInt(e.target.value);
        const display = qs('[data-display="numGroups"]', state.modal);
        if (display) display.textContent = state.numGroups;
      };
    }

    const incrBtn = qs('[data-action="increment-groups"]', state.modal);
    const decrBtn = qs('[data-action="decrement-groups"]', state.modal);

    if (incrBtn) incrBtn.onclick = () => changeNumGroups(1);
    if (decrBtn) decrBtn.onclick = () => changeNumGroups(-1);

    qsa('input[name="subject"]', state.modal).forEach(radio => {
      radio.onchange = (e) => {
        state.selectedSubject = e.target.value;
        updateUI();
      };
    });

    qsa('input[name="distribution"]', state.modal).forEach(radio => {
      radio.onchange = (e) => {
        state.distributionType = e.target.value;
        updateUI();
      };
    });

    qsa('input[name="language"]', state.modal).forEach(radio => {
      radio.onchange = (e) => {
        state.selectedLanguage = e.target.value;
        updateUI();
      };
    });

    // Ã‰tape 5 : Actions sur les groupes
    const toggleStatsBtn = qs('[data-action="toggle-statistics"]', state.modal);
    const regenerateBtn = qs('[data-action="regenerate"]', state.modal);
    const saveModeButtons = qsa('[data-action="set-save-mode"]', state.modal);
    const saveTempBtn = qs('[data-action="save-temp-groups"]', state.modal);
    const loadTempBtn = qs('[data-action="load-temp-groups"]', state.modal);
    const finalizeTempBtn = qs('[data-action="finalize-temp-groups"]', state.modal);
    const exportPdfBtn = qs('[data-action="export-pdf"]', state.modal);
    const exportCsvBtn = qs('[data-action="export-csv"]', state.modal);
    const snapshotsBtn = qs('[data-action="show-snapshots"]', state.modal);
    const auditHistoryBtn = qs('[data-action="show-audit-history"]', state.modal);

    if (toggleStatsBtn) toggleStatsBtn.onclick = toggleStatistics;
    if (regenerateBtn) regenerateBtn.onclick = generateGroups;

    // Handlers pour les boutons de mode (Replace vs Append)
    saveModeButtons.forEach(btn => {
      btn.onclick = (e) => {
        const mode = e.target.closest('button').getAttribute('data-mode');

        // Si persistMode=true (en train de continuer une sÃ©rie), FORCER le mode Ã  'append'
        if (state.persistMode && mode === 'replace') {
          showToast('âš ï¸ Vous continuez une sÃ©rie! Mode AJOUTER forcÃ©.', 'warning');
          state.saveMode = 'append';
        } else {
          state.saveMode = mode;
        }

        updateUI();
        const modeLabel = state.saveMode === 'replace' ? 'Remplacer' : 'Ajouter';
        const persistLabel = state.persistMode ? ` (continue de ${state.lastTempRange.min}-${state.lastTempRange.max})` : '';
        showToast(`Mode: ${modeLabel}${persistLabel}`, 'info');
      };
    });

    if (saveTempBtn) saveTempBtn.onclick = saveTempGroupsUI;
    if (loadTempBtn) loadTempBtn.onclick = loadTempGroupsUI;
    if (finalizeTempBtn) finalizeTempBtn.onclick = finalizeTempGroupsUI;
    if (exportPdfBtn) exportPdfBtn.onclick = exportToPDF;
    if (exportCsvBtn) exportCsvBtn.onclick = exportToCSV;
    if (snapshotsBtn) {
      snapshotsBtn.onclick = () => {
        if (state.generatedGroups.length > 0) {
          const groupName = `${getGroupPrefix()}${state.tempOffsetStart}`;
          showSnapshotBrowser(groupName);
        } else {
          showToast('Aucun groupe gÃ©nÃ©rÃ©. Finalisez d\'abord des groupes pour voir les snapshots.', 'info');
        }
      };
    }
    if (auditHistoryBtn) {
      auditHistoryBtn.onclick = () => {
        if (state.generatedGroups.length > 0) {
          const groupName = `${getGroupPrefix()}${state.tempOffsetStart}`;
          showAuditHistory(groupName);
        } else {
          showToast('Aucun groupe gÃ©nÃ©rÃ©. Finalisez d\'abord des groupes pour voir l\'historique.', 'info');
        }
      };
    }

    // Initialiser Drag & Drop si on est Ã  l'Ã©tape 5
    if (state.currentStep === 5 && state.generatedGroups.length > 0) {
      initializeDragAndDrop();
    }
  }

  function handlePrimaryAction() {
    if (state.currentStep === 1) {
      if (!state.groupType) {
        showToast('Veuillez sÃ©lectionner un type de groupes', 'warning');
        return;
      }
      nextStep();
    } else if (state.currentStep === 2) {
      if (state.selectedClasses.length === 0) {
        showToast('Veuillez sÃ©lectionner au moins une classe', 'warning');
        return;
      }
      nextStep();
    } else if (state.currentStep === 3) {
      nextStep();
    } else if (state.currentStep === 4) {
      generateGroups();
    } else if (state.currentStep === 5) {
      closeModal();
    }
  }

  function handleSecondaryAction() {
    if (state.currentStep === 1) {
      closeModal();
    } else if (state.currentStep === 5) {
      resetToStep1();
    } else {
      previousStep();
    }
  }

  function nextStep() {
    if (state.currentStep < state.totalSteps) {
      state.currentStep++;

      // Charger les classes si on arrive Ã  l'Ã©tape 2
      if (state.currentStep === 2 && state.availableClasses.length === 0) {
        loadAvailableClasses();
      }

      updateUI();
    }
  }

  function previousStep() {
    if (state.currentStep > 1) {
      state.currentStep--;
      updateUI();
    }
  }

  function resetToStep1() {
    // Si une sauvegarde TEMP prÃ©cÃ©dente existe, proposer "Continuer" vs "Recommencer"
    if (state.lastTempRange && state.lastTempRange.count > 0) {
      const continueChoice = confirm(
        `ğŸ“Š Vague prÃ©cÃ©dente: ${state.lastTempRange.typePrefix}${state.lastTempRange.min} Ã  ` +
        `${state.lastTempRange.typePrefix}${state.lastTempRange.max} (${state.lastTempRange.count} groupes)\n\n` +
        `Voulez-vous AJOUTER une nouvelle vague Ã  cette sÃ©rie?\n\n` +
        `[OK] Continuer la sÃ©rie (prochains numÃ©ros: ${state.tempOffsetStart}+)\n` +
        `[Annuler] Recommencer une nouvelle sÃ©rie`
      );

      if (continueChoice) {
        // Continuer la sÃ©rie: rÃ©initialiser les groupes mais conserver l'offset
        state.currentStep = 1;
        state.selectedClasses = [];
        state.generatedGroups = [];
        state.persistMode = true; // Flag pour les saveMode par dÃ©faut
        // groupType reste le mÃªme
        showToast(
          `Prochains groupes seront numÃ©rotÃ©s Ã  partir de ${state.tempOffsetStart}`,
          'info'
        );
      } else {
        // Recommencer: rÃ©initialiser TOUT
        state.currentStep = 1;
        state.groupType = null;
        state.selectedClasses = [];
        state.generatedGroups = [];
        state.lastTempRange = null;
        state.tempOffsetStart = 1;
        state.persistMode = false;
        showToast('Nouvelle sÃ©rie lancÃ©e', 'info');
      }
    } else {
      // Pas de sauvegarde prÃ©cÃ©dente: reset simple
      state.currentStep = 1;
      state.groupType = null;
      state.selectedClasses = [];
      state.generatedGroups = [];
    }
    updateUI();
  }

  function selectGroupType(type) {
    state.groupType = type;
    updateUI();
    // Auto-avancer aprÃ¨s sÃ©lection
    setTimeout(() => nextStep(), 300);
  }

  function handleClassSelection(e) {
    const classe = e.target.value;
    console.log('[DEBUG] Checkbox clicked:');
    console.log('   value:', classe);
    console.log('   checked:', e.target.checked);
    console.log('   Avant:', state.selectedClasses);

    if (e.target.checked) {
      if (!state.selectedClasses.includes(classe)) {
        state.selectedClasses.push(classe);
        console.log('   âœ… AjoutÃ©e');
      } else {
        console.log('   âš ï¸ DÃ©jÃ  prÃ©sente');
      }
    } else {
      const before = state.selectedClasses.length;
      state.selectedClasses = state.selectedClasses.filter(c => c !== classe);
      const after = state.selectedClasses.length;
      console.log('   âŒ RetirÃ©e (avant:', before, 'aprÃ¨s:', after, ')');
    }
    console.log('   AprÃ¨s:', state.selectedClasses);
    updateUI();
  }

  function selectAllClasses() {
    console.log('[DEBUG] selectAllClasses() appelÃ©e');
    console.log('   availableClasses:', state.availableClasses);
    state.selectedClasses = [...state.availableClasses];
    console.log('   selectedClasses aprÃ¨s:', state.selectedClasses);
    updateUI();
  }

  function deselectAllClasses() {
    console.log('[DEBUG] deselectAllClasses() appelÃ©e');
    console.log('   Avant:', state.selectedClasses);
    state.selectedClasses = [];
    console.log('   AprÃ¨s:', state.selectedClasses);
    updateUI();
  }

  function changeNumGroups(delta) {
    state.numGroups = Math.max(1, Math.min(10, state.numGroups + delta));
    updateUI();
  }

  function updateUI() {
    if (!state.modal) return;

    // Re-render du contenu
    const container = qs('[data-step-container]', state.modal);
    if (container) {
      container.innerHTML = renderStepContent();
    }

    // Update stepper
    qsa('.stepper-step', state.modal).forEach((step, index) => {
      const stepNum = index + 1;
      step.classList.toggle('active', stepNum <= state.currentStep);
      step.classList.toggle('current', stepNum === state.currentStep);
    });

    // Update footer
    const footerInfo = qs('[data-footer-info]', state.modal);
    const primaryBtn = qs('[data-action="primary"]', state.modal);
    const secondaryBtn = qs('[data-action="secondary"]', state.modal);

    if (footerInfo) footerInfo.innerHTML = getFooterInfo();
    if (primaryBtn) primaryBtn.textContent = getPrimaryButtonLabel();
    if (secondaryBtn) secondaryBtn.textContent = getSecondaryButtonLabel();

    // Update header gradient
    const header = qs('header', state.modal);
    if (header && state.groupType) {
      const iconWrapper = qs('.h-14', header);
      if (iconWrapper) {
        iconWrapper.className = `h-14 w-14 rounded-2xl bg-gradient-to-br ${GROUP_TYPES[state.groupType].color} flex items-center justify-center text-3xl shadow-lg`;
        iconWrapper.textContent = GROUP_TYPES[state.groupType].icon;
      }
    }

    // Re-attach event listeners
    attachEventListeners();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CHARGEMENT DES DONNÃ‰ES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function loadAvailableClasses() {
    console.log('ğŸ“¡ [GroupsModule] Chargement des classes (DOM + backend)...');

    state.isLoading = true;
    state.loadError = null;

    // 1. Snapshot local direct depuis le board visible
    const domSnapshot = snapshotClassesFromDOMForGroups(); // { "6Â°2": {eleves:[...]}, ... }
    const domClasses = Object.keys(domSnapshot);
    console.log('[GroupsModule] Classes dÃ©tectÃ©es dans le DOM :', domClasses);

    // Cas offline / pas d'Apps Script â†’ on vit uniquement avec le DOM
    if (!google?.script?.run) {
      console.warn('[GroupsModule] google.script.run indisponible â†’ fallback DOM ONLY');
      state.isLoading = false;
      state.classKeyMap = {};
      state.classesData = domSnapshot;           // on stocke DIRECT
      state.availableClasses = domClasses.slice();
      if (!state.selectedClasses.length) {
        state.selectedClasses = domClasses.slice();
      }

      // petit log rÃ©cap
      let total = 0;
      state.availableClasses.forEach(c => {
        total += (state.classesData[c]?.eleves || []).length;
      });
      console.log(`[GroupsModule] Total d'Ã©lÃ¨ves (DOM only): ${total}`);

      updateUI();
      showToast(`âœ… ${domClasses.length} classe(s) dÃ©tectÃ©e(s) / ${total} Ã©lÃ¨ve(s)`, 'success');
      return;
    }

    // 2. Sinon, on tente aussi le backend pour complÃ©ter les infos
    google.script.run
      .withSuccessHandler(result => {
        console.log('[GroupsModule] RÃ©ponse getClassesData:', result);
        state.isLoading = false;

        if (!result || !result.data) {
          console.warn('[GroupsModule] Backend vide ou invalide â†’ on reste 100% DOM');
          finalizeUsingMergedData(domClasses, domSnapshot, {}, {});
          return;
        }

        const backendData = result.data;                 // ex: { "6E2FIN": {eleves:[...]}, ... }
        const backendKeys = Object.keys(backendData);
        console.log('[GroupsModule] ClÃ©s brutes renvoyÃ©es par getClassesData:', backendKeys);

        // On va essayer de faire correspondre chaque classe affichÃ©e ("6Â°2")
        // avec une clÃ© backend ("6E2FIN") en utilisant canonicalClass().
        const mapping = {};
        const mergedData = {};

        domClasses.forEach(displayName => {
          const domCanon = canonicalClass(displayName);
          console.log(`   ğŸ” Tentative correspondance pour "${displayName}" (canon: "${domCanon}")`);

          let winnerKey = null;
          for (const k of backendKeys) {
            const kCanon = canonicalClass(k);
            if (
              kCanon === domCanon ||
              kCanon.startsWith(domCanon) ||
              domCanon.startsWith(kCanon)
            ) {
              winnerKey = k;
              break;
            }
          }

          if (winnerKey) {
            console.log(`   âœ… Match backend "${winnerKey}" pour "${displayName}"`);
            mapping[displayName] = winnerKey;

            // prioritÃ© backend si prÃ©sent,
            // sinon on retombe sur le DOM (par cohÃ©rence visuelle)
            mergedData[displayName] = backendData[winnerKey] && backendData[winnerKey].eleves
              ? { eleves: backendData[winnerKey].eleves.slice() }
              : (domSnapshot[displayName] || { eleves: [] });

          } else {
            console.warn(`   âš ï¸ Pas de correspondance backend pour "${displayName}" â†’ on prend le DOM en source`);
            mapping[displayName] = displayName;
            mergedData[displayName] = domSnapshot[displayName] || { eleves: [] };
          }
        });

        finalizeUsingMergedData(domClasses, mergedData, mapping, backendData);
      })
      .withFailureHandler(error => {
        state.isLoading = false;
        console.error('[GroupsModule] Erreur getClassesData:', error);
        showToast('âŒ Erreur backend, utilisation des donnÃ©es visibles Ã  l\'Ã©cran', 'warning');

        // backend KO â†’ full DOM
        finalizeUsingMergedData(domClasses, domSnapshot, {}, {});
      })
      .loadFINSheetsWithScores(); // ğŸ”‘ Charge les onglets FIN avec SCORE F et SCORE M
  }

  // Helper interne pour factoriser la fin du chargement
  function finalizeUsingMergedData(domClasses, mergedData, mapping, backendData) {
    state.classKeyMap = mapping || {};
    state.classesData = mergedData || {};
    state.availableClasses = domClasses.slice();

    console.log('[DEBUG loadAvailableClasses] Avant auto-sÃ©lection:');
    console.log('   selectedClasses:', state.selectedClasses);
    console.log('   availableClasses:', state.availableClasses);

    // Auto-sÃ©lection si rien n'est encore choisi
    if (!state.selectedClasses || state.selectedClasses.length === 0) {
      console.log('[DEBUG loadAvailableClasses] Auto-sÃ©lection activÃ©e (aucune classe prÃ©alablement sÃ©lectionnÃ©e)');
      state.selectedClasses = state.availableClasses.slice();
      console.log('   selectedClasses aprÃ¨s auto-sÃ©lection:', state.selectedClasses);
    }

    // Compte combien d'Ã©lÃ¨ves on a vraiment
    let totalStudents = 0;
    state.availableClasses.forEach(name => {
      const bucket = state.classesData[name];
      if (bucket && Array.isArray(bucket.eleves)) {
        totalStudents += bucket.eleves.length;
      }
    });

    console.log('[GroupsModule] Mapping affichageâ†’backend:', state.classKeyMap);
    console.log('[GroupsModule] Liste finale des classes pÃ©dagogiques:', state.availableClasses);
    console.log('[GroupsModule] selectedClasses au fin de loadAvailableClasses:', state.selectedClasses);
    console.log(`[GroupsModule] Total d'Ã©lÃ¨ves disponibles aprÃ¨s fusion DOM/backend: ${totalStudents}`);

    updateUI();

    if (state.availableClasses.length === 0) {
      state.loadError = 'Aucune classe dÃ©tectÃ©e';
      showToast('âš ï¸ Aucune classe dÃ©tectÃ©e', 'warning');
    } else {
      showToast(
        `âœ… ${state.availableClasses.length} classe(s) dÃ©tectÃ©e(s) / ${totalStudents} Ã©lÃ¨ve(s)`,
        'success'
      );
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SPRINT #1 : CHARGEMENT CONTINUATION (PropertiesService)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function loadContinuationIfNeeded() {
    // Chargement unique des mÃ©tadonnÃ©es de continuation
    // AppelÃ©e une seule fois au dÃ©marrage step 1
    if (!google?.script?.run) {
      console.warn('[GroupsModule] google.script.run non disponible, skip continuation load');
      return;
    }

    google.script.run
      .withSuccessHandler((result) => {
        if (!result?.success) {
          console.log('[GroupsModule] â„¹ï¸  Pas de continuation metadata trouvÃ©e');
          return;
        }

        const metadata = result.metadata;
        if (!metadata || !metadata.lastTempRange) {
          console.log('[GroupsModule] â„¹ï¸  Continuation metadata vide');
          return;
        }

        // ğŸ”„ Restaurer l'Ã©tat de continuation depuis le serveur
        state.lastTempRange = metadata.lastTempRange;
        state.tempOffsetStart = metadata.tempOffsetStart;
        state.persistMode = metadata.persistMode || false;

        console.log('[GroupsModule] âœ… Continuation metadata restaurÃ©e!');
        console.log('   lastTempRange:', state.lastTempRange);
        console.log('   tempOffsetStart:', state.tempOffsetStart);
        console.log('   persistMode:', state.persistMode);

        // Montrer le dialog de continuation si applicable
        if (state.lastTempRange && state.lastTempRange.count > 0) {
          const continueChoice = confirm(
            `ğŸ“Š Vague prÃ©cÃ©dente restaurÃ©e: ${state.lastTempRange.typePrefix}${state.lastTempRange.min} Ã  ` +
            `${state.lastTempRange.typePrefix}${state.lastTempRange.max} (${state.lastTempRange.count} groupes)\n\n` +
            `Voulez-vous AJOUTER une nouvelle vague Ã  cette sÃ©rie?\n\n` +
            `[OK] Continuer la sÃ©rie (prochains numÃ©ros: ${state.tempOffsetStart}+)\n` +
            `[Annuler] Recommencer une nouvelle sÃ©rie`
          );

          if (continueChoice) {
            state.persistMode = true;
            state.generatedGroups = [];
            state.selectedClasses = [];
            // groupType persiste
            showToast(
              `ğŸ”„ Continuation activÃ©e : prochains groupes ${state.tempOffsetStart}+`,
              'success'
            );
          } else {
            // Supprimer les mÃ©tadonnÃ©es pour recommencer
            google.script.run
              .withSuccessHandler(() => {
                console.log('[GroupsModule] MÃ©tadonnÃ©es de continuation supprimÃ©es');
              })
              .clearContinuationMetadata(state.groupType);

            state.lastTempRange = null;
            state.tempOffsetStart = 1;
            state.persistMode = false;
            showToast('ğŸ”„ Nouvelle sÃ©rie lancÃ©e', 'info');
          }
        }

        updateUI();
      })
      .withFailureHandler((error) => {
        console.error('[GroupsModule] Erreur lors du chargement continuation:', error);
      })
      .loadContinuationMetadata(state.groupType);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  CHARGEMENT DES Ã‰LÃˆVES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function loadStudentsFromClasses() {
    console.log('[GroupsModule] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('[GroupsModule] Chargement des Ã©lÃ¨ves via classesData fusionnÃ©e...');
    console.log('[GroupsModule] ğŸ” DEBUG - selectedClasses:', state.selectedClasses);
    console.log('[GroupsModule] ğŸ” DEBUG - selectedClasses.length:', state.selectedClasses.length);
    console.log('[GroupsModule] ğŸ” DEBUG - ClÃ©s disponibles dans classesData:', Object.keys(state.classesData));
    console.log('[GroupsModule] ğŸ” DEBUG - availableClasses:', state.availableClasses);

    if (!state.classesData || Object.keys(state.classesData).length === 0) {
      showToast('âŒ DonnÃ©es des classes non chargÃ©es', 'error');
      return Promise.reject('No classes data');
    }

    return new Promise((resolve, reject) => {
      try {
        const students = [];

        (state.selectedClasses || []).forEach(displayName => {
          const bucket = state.classesData[displayName];

          if (!bucket || !Array.isArray(bucket.eleves)) {
            console.warn(`[GroupsModule] âŒ Pas de bucket valide pour "${displayName}"`);
            return;
          }

          console.log(`[GroupsModule] âœ… "${displayName}" : ${bucket.eleves.length} Ã©lÃ¨ve(s)`);

          bucket.eleves.forEach((e, idx) => {
            if (!e) return;

            // 1. RÃ©cup FR / MATH envoyÃ©s par Apps Script
            //    -> e.scoreF et e.scoreM (ex: 11.5 / 8.0)
            const fScore = (typeof e.scoreF === 'number') ? e.scoreF
                         : (typeof e.scores?.F === 'number') ? e.scores.F
                         : null;

            const mScore = (typeof e.scoreM === 'number') ? e.scoreM
                         : (typeof e.scores?.M === 'number') ? e.scores.M
                         : null;

            // 2. RÃ©cup comportement / travail / etc.
            const comVal  = (e.com  ?? e.scores?.COM  ?? 0);
            const traVal  = (e.tra  ?? e.scores?.TRA  ?? 0);
            const partVal = (e.part ?? e.scores?.PART ?? 0);
            const absVal  = (e.abs  ?? e.scores?.ABS  ?? 0);

            // 3. Construire l'Ã©lÃ¨ve normalisÃ©
            const normalized = {
              // IdentitÃ©
              id:     e.id || e.ID || e.identifiant || `${displayName}_${idx}`,
              nom:    e.nom || e.NOM || e.lastName || '',
              prenom: e.prenom || e.PRENOM || e.firstName || '',
              sexe:   e.sexe || e.SEXE || e.sex || '',
              classe: displayName,

              // Options et source d'origine
              lv2: e.lv2 || e.LV2 || null,
              opt: e.opt || e.OPT || null,
              source: e.source || e.SOURCE || null,  // classe d'annÃ©e prÃ©cÃ©dente

              // Scores bruts regroupÃ©s
              scores: {
                // ce bloc est ce que les autres fonctions lisent
                F:    (typeof fScore === 'number' ? fScore : null),   // FranÃ§ais attendu par computeGroupStats()
                M:    (typeof mScore === 'number' ? mScore : null),   // Maths attendu par computeGroupStats()
                COM:  comVal,
                TRA:  traVal,
                PART: partVal,
                ABS:  absVal
              },

              // Duplication top-level pour l'UI comportement
              com:  comVal,
              tra:  traVal,
              part: partVal,
              abs:  absVal,

              // Duplication top-level pour debug ou affichage direct si besoin
              scoreF: fScore,
              scoreM: mScore
            };

            students.push(normalized);
          });
        });

        // CORRECTIF A : Appliquer normalizeScores sur chaque Ã©lÃ¨ve
        // pour garantir que scores.F et scores.M existent quelle que soit la source
        state.students = students.map(normalizeScores);
        state.studentsById = new Map(state.students.map(s => [s.id, s]));

        console.log(`[GroupsModule] ğŸ“Š Total d'Ã©lÃ¨ves chargÃ©s: ${state.students.length}`);
        console.log('[GroupsModule] ğŸ” DEBUG - Premier Ã©lÃ¨ve normalisÃ©:', state.students[0]);
        console.log('[GroupsModule] âœ… Scores normalisÃ©s pour tous les Ã©lÃ¨ves');

        // FIX 3 : Filtrer les Ã©lÃ¨ves selon le type de groupe
        // Langage : filtrer par LV2 sÃ©lectionnÃ©e
        if (state.groupType === 'language' && state.selectedLanguage) {
          const beforeFilter = state.students.length;
          state.students = state.students.filter(s => {
            const studentLV2 = (s.lv2 || s.LV2 || '').toString().toUpperCase().trim();
            const selectedLV2 = state.selectedLanguage.toUpperCase().trim();
            return studentLV2 === selectedLV2;
          });
          const afterFilter = state.students.length;
          console.log(`[GroupsModule] ğŸŒ Filtre LV2 appliquÃ©: ${beforeFilter} â†’ ${afterFilter} Ã©lÃ¨ves (LV2="${state.selectedLanguage}")`);

          // Reconstruire la Map avec les Ã©lÃ¨ves filtrÃ©s
          state.studentsById = new Map(state.students.map(s => [s.id, s]));
        }

        // Options : filtrer par option sÃ©lectionnÃ©e (futur module)
        if (state.groupType === 'option' && state.selectedOption) {
          const beforeFilter = state.students.length;
          state.students = state.students.filter(s => {
            const studentOpt = (s.opt || s.OPT || '').toString().toUpperCase().trim();
            const selectedOpt = state.selectedOption.toUpperCase().trim();
            return studentOpt === selectedOpt;
          });
          const afterFilter = state.students.length;
          console.log(`[GroupsModule] ğŸ¯ Filtre OPT appliquÃ©: ${beforeFilter} â†’ ${afterFilter} Ã©lÃ¨ves (OPT="${state.selectedOption}")`);

          // Reconstruire la Map avec les Ã©lÃ¨ves filtrÃ©s
          state.studentsById = new Map(state.students.map(s => [s.id, s]));
        }

        resolve(students);
      } catch (error) {
        console.error('[GroupsModule] Erreur loadStudentsFromClasses:', error);
        showToast('âŒ Erreur lors du chargement des Ã©lÃ¨ves', 'error');
        reject(error);
      }
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  GÃ‰NÃ‰RATION DES GROUPES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  HELPERS POUR RÃ‰PARTITION INTELLIGENTE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function getNeedScoreForStudent(stu) {
    // rÃ©cupÃ¨re F / M tels qu'on les a normalisÃ©s
    const f = (typeof stu.scores?.F === 'number') ? stu.scores.F : null;
    const m = (typeof stu.scores?.M === 'number') ? stu.scores.M : null;

    // selon le rÃ©glage de l'UI
    if (state.selectedSubject === 'maths') {
      return (m !== null ? m : 0);
    }
    if (state.selectedSubject === 'french') {
      return (f !== null ? f : 0);
    }

    // both -> on prend la moyenne dispo
    if (f !== null && m !== null) return (f + m) / 2;
    if (f !== null) return f;
    if (m !== null) return m;
    return 0;
  }

  // tri dÃ©croissant : meilleurs en premier
  function sortByNeedScoreDesc(students) {
    return [...students].sort((a, b) => {
      return getNeedScoreForStudent(b) - getNeedScoreForStudent(a);
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SPRINT #2 : SCORE COMPOSITE & OPTIMISATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Calcule un score composite pour chaque Ã©lÃ¨ve
   * PondÃ©ration : F(0.35) + M(0.35) + COM(0.15) + PART(0.15)
   */
  function getCompositeScore(student) {
    const f = Number(student.scores?.F ?? student.scoreF ?? 0);
    const m = Number(student.scores?.M ?? student.scoreM ?? 0);
    const com = Number(student.com ?? 0);
    const part = Number(student.part ?? 0);

    // Normaliser COM et PART sur 0-20 si nÃ©cessaire (souvent 0-5)
    const comNorm = com <= 5 ? com * 4 : com;  // 5 â†’ 20 pts max
    const partNorm = part <= 5 ? part * 4 : part;  // 5 â†’ 20 pts max

    // Score composite pondÃ©rÃ©
    return (f * 0.35) + (m * 0.35) + (comNorm * 0.15) + (partNorm * 0.15);
  }

  /**
   * Calcule l'Ã©cart-type des scores composites par groupe
   */
  function calculateGroupScoreStdDev(groups) {
    const groupAvgs = groups.map(g => {
      if (g.students.length === 0) return 0;
      const sum = g.students.reduce((s, stu) => s + getCompositeScore(stu), 0);
      return sum / g.students.length;
    });
    const mean = groupAvgs.reduce((a, b) => a + b, 0) / groupAvgs.length;
    const variance = groupAvgs.reduce((sum, avg) => sum + Math.pow(avg - mean, 2), 0) / groupAvgs.length;
    return Math.sqrt(variance);
  }

  /**
   * Optimise les groupes via Ã©changes itÃ©ratifs (local search)
   * Essaie de minimiser l'Ã©cart-type des scores
   */
  function optimizeGroupsWithSwaps(groups, maxIterations = 50) {
    let improved = true;
    let iteration = 0;
    let bestStdDev = calculateGroupScoreStdDev(groups);

    console.log(`[GroupsModule] ğŸ”„ Optimisation : Ã©cart-type initial = ${bestStdDev.toFixed(3)}`);

    while (improved && iteration < maxIterations) {
      improved = false;
      iteration++;

      // Essayer les Ã©changes entre paires de groupes
      for (let i = 0; i < groups.length && !improved; i++) {
        for (let j = i + 1; j < groups.length && !improved; j++) {
          // Essayer d'Ã©changer un Ã©lÃ¨ve de groupe i avec un de groupe j
          for (let ki = 0; ki < groups[i].students.length && !improved; ki++) {
            for (let kj = 0; kj < groups[j].students.length && !improved; kj++) {
              // Swap temporaire
              const tempI = groups[i].students[ki];
              const tempJ = groups[j].students[kj];

              groups[i].students[ki] = tempJ;
              groups[j].students[kj] = tempI;

              // Calculer nouvel Ã©cart-type
              const newStdDev = calculateGroupScoreStdDev(groups);

              if (newStdDev < bestStdDev - 0.001) {
                // AmÃ©lioration significative, garder le swap
                bestStdDev = newStdDev;
                improved = true;
                console.log(`   âœ… ItÃ©ration ${iteration}: swap G${i}-G${j} â†’ Ïƒ=${newStdDev.toFixed(3)}`);
              } else {
                // Pas d'amÃ©lioration, remettre en place
                groups[i].students[ki] = tempI;
                groups[j].students[kj] = tempJ;
              }
            }
          }
        }
      }
    }

    console.log(`[GroupsModule] ğŸ¯ Optimisation terminÃ©e en ${iteration} itÃ©rations. Ã‰cart-type final: ${bestStdDev.toFixed(3)}`);
  }

  function generateGroupsLocally() {
    const num = state.numGroups || 3;
    if (!Array.isArray(state.students) || state.students.length === 0) {
      console.warn('[GroupsModule] Pas d\'Ã©lÃ¨ves pour gÃ©nÃ©rer les groupes');
      state.generatedGroups = [];
      return;
    }

    // ğŸ†• Ã‰TAPE 1 : Trier par score composite (au lieu de juste besoin acadÃ©mique)
    const studentsWithScores = state.students.map(s => ({
      ...s,
      compositeScore: getCompositeScore(s)
    }));

    const sorted = studentsWithScores.sort((a, b) => b.compositeScore - a.compositeScore);

    console.log('[GroupsModule] ğŸ“Š Distribution par mode:', state.distributionType);
    console.log('[GroupsModule] ğŸ“ Score composite (F:0.35, M:0.35, COM:0.15, PART:0.15)');
    console.log('[GroupsModule] Top 3 Ã©lÃ¨ves:', sorted.slice(0, 3).map(s =>
      `${s.nom} (composite: ${s.compositeScore.toFixed(1)})`
    ));

    // ğŸ†• Ã‰TAPE 2 : Ã‰quilibrer paritÃ©
    const girls = sorted.filter(s => (s.sexe || '').toUpperCase() === 'F');
    const boys = sorted.filter(s => (s.sexe || '').toUpperCase() === 'M');
    const other = sorted.filter(s => {
      const sx = (s.sexe || '').toUpperCase();
      return sx !== 'F' && sx !== 'M';
    });

    console.log('[GroupsModule] ğŸ‘© Filles: ' + girls.length + ' | ğŸ‘¨ GarÃ§ons: ' + boys.length + ' | â“ Autres: ' + other.length);

    // Entrelacers F et M en gardant l'ordre de score
    const balanced = [];
    const maxLen = Math.max(girls.length, boys.length);
    for (let i = 0; i < maxLen; i++) {
      if (i < girls.length) balanced.push(girls[i]);
      if (i < boys.length) balanced.push(boys[i]);
    }
    balanced.push(...other);

    console.log('[GroupsModule] âœ… Liste Ã©quilibrÃ©e (F/M entrelacÃ©es, score composite): ' + balanced.length + ' Ã©lÃ¨ves');

    // ğŸ†• Ã‰TAPE 3 : CrÃ©er groupes avec distribution intelligente
    const groups = Array.from({ length: num }, (_, idx) => ({
      name: `Groupe ${state.tempOffsetStart + idx}`,
      students: []
    }));

    if (state.distributionType === 'homogeneous') {
      // HomogÃ¨ne = blocs sÃ©quentiels
      const chunkSize = Math.ceil(balanced.length / num);
      for (let g = 0; g < num; g++) {
        const slice = balanced.slice(g * chunkSize, (g + 1) * chunkSize);
        groups[g].students.push(...slice);
      }
      console.log('[GroupsModule] âœ… Distribution homogÃ¨ne (niveaux Ã©quilibrÃ©s)');
    } else {
      // HÃ©tÃ©rogÃ¨ne = snake draft
      let forward = true;
      let index = 0;
      balanced.forEach(stu => {
        groups[index].students.push(stu);
        if (forward) {
          index++;
          if (index >= num) {
            index = num - 1;
            forward = false;
          }
        } else {
          index--;
          if (index < 0) {
            index = 0;
            forward = true;
          }
        }
      });
      console.log('[GroupsModule] âœ… Distribution hÃ©tÃ©rogÃ¨ne (snake draft)');
    }

    // ğŸ†• Ã‰TAPE 4 : Optimiser avec Ã©changes itÃ©ratifs
    optimizeGroupsWithSwaps(groups);

    state.generatedGroups = groups;
    state.lastGeneration = new Date();

    // Log de vÃ©rification finale
    groups.forEach((g, idx) => {
      const avgScore = g.students.length > 0
        ? (g.students.reduce((sum, s) => sum + getCompositeScore(s), 0) / g.students.length).toFixed(2)
        : 0;
      const girls = g.students.filter(s => (s.sexe || '').toUpperCase() === 'F').length;
      const boys = g.students.length - girls;
      console.log(`[GroupsModule] ${g.name}: ${g.students.length} Ã©lÃ¨ves (${girls}F/${boys}M), score moyen: ${avgScore}`);
    });
  }

  function generateGroups() {
    state.isLoading = true;
    state.loadError = null;
    updateUI();

    const ensureStudentsReady = state.students && state.students.length > 0
      ? Promise.resolve(state.students)
      : loadStudentsFromClasses();

    ensureStudentsReady
      .then(() => {
        generateGroupsLocally(); // crÃ©e state.generatedGroups
        state.isLoading = false;
        state.currentStep = 5;   // on passe Ã  l'aperÃ§u
        updateUI();
        showToast(`${state.generatedGroups.length} groupes gÃ©nÃ©rÃ©s`, 'success');
      })
      .catch(err => {
        state.isLoading = false;
        state.loadError = err?.message || String(err);
        updateUI();
        showToast('Impossible de gÃ©nÃ©rer les groupes', 'error');
      });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  DRAG & DROP avec SortableJS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function initializeDragAndDrop() {
    // Nettoyer les anciens sortables
    state.sortables.forEach(sortable => {
      try {
        sortable.destroy();
      } catch (e) {}
    });
    state.sortables = [];

    // VÃ©rifier que Sortable est disponible
    if (typeof Sortable === 'undefined') {
      console.warn('âš ï¸ SortableJS non disponible, drag & drop dÃ©sactivÃ©');
      return;
    }

    // CrÃ©er un sortable pour chaque groupe
    qsa('[data-group-id]', state.modal).forEach(groupEl => {
      const groupId = parseInt(groupEl.dataset.groupId);

      const sortable = Sortable.create(groupEl, {
        group: 'groups',
        animation: 200,
        handle: '.student-card',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',

        onEnd: function(evt) {
          const fromGroupId = parseInt(evt.from.dataset.groupId);
          const toGroupId = parseInt(evt.to.dataset.groupId);
          const studentId = evt.item.dataset.studentId;

          if (fromGroupId !== toGroupId) {
            moveStudent(studentId, fromGroupId, toGroupId);
          }
        }
      });

      state.sortables.push(sortable);
    });
  }

  function moveStudent(studentId, fromGroupIndex, toGroupIndex) {
    // Trouver l'Ã©lÃ¨ve dans le groupe source
    const fromGroup = state.generatedGroups[fromGroupIndex];
    const studentIndex = fromGroup.students.findIndex(s => s.id === studentId);

    if (studentIndex === -1) return;

    const student = fromGroup.students[studentIndex];

    // Retirer du groupe source
    fromGroup.students.splice(studentIndex, 1);

    // Ajouter au groupe cible
    state.generatedGroups[toGroupIndex].students.push(student);

    // Mettre Ã  jour l'affichage des stats
    updateGroupStats(fromGroupIndex);
    updateGroupStats(toGroupIndex);

    showToast(`${student.nom} dÃ©placÃ© vers ${state.generatedGroups[toGroupIndex].name}`, 'info', 2000);
  }

  function updateGroupStats(groupIndex) {
    const groupCard = qs(`[data-group-index="${groupIndex}"]`, state.modal);
    if (!groupCard) return;

    const group = state.generatedGroups[groupIndex];
    const stats = calculateGroupStats(group);

    // Update count
    const countEl = qs('.group-count', groupCard);
    if (countEl) countEl.textContent = `${group.students.length} Ã©lÃ¨ves`;

    // Update stats
    const statsContainer = qs('.group-stats', groupCard);
    if (statsContainer) {
      statsContainer.innerHTML = `
        <div class="stat-item">
          <i class="fas fa-venus-mars text-pink-600"></i>
          <span>${stats.girls}F / ${stats.boys}M</span>
        </div>
        ${state.groupType === 'needs' ? `
          <div class="stat-item">
            <i class="fas fa-chart-line text-blue-600"></i>
            <span>Moy: ${stats.avgScore}</span>
          </div>
        ` : ''}
        ${state.groupType === 'language' ? `
          <div class="stat-item">
            <i class="fas fa-comments text-purple-600"></i>
            <span>PART: ${stats.avgPart}</span>
          </div>
        ` : ''}
      `;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SAUVEGARDE & EXPORT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function saveTempGroupsUI() {
    if (!google?.script?.run) {
      showToast('Google Apps Script non disponible', 'error');
      return;
    }

    if (!state.generatedGroups || state.generatedGroups.length === 0) {
      showToast('Aucun groupe Ã  sauvegarder', 'warning');
      return;
    }

    // D'abord vÃ©rifier s'il y a des TEMP existants pour ce type
    showToast('VÃ©rification des groupes existants...', 'info');

    google.script.run
      .withSuccessHandler((listResult) => {
        // Si des TEMP existent, vÃ©rifier le mode utilisateur
        if (listResult.success && listResult.count > 0) {
          const existingInfo = `Groupes TEMP existants trouvÃ©s: ${listResult.minNumber} Ã  ${listResult.maxNumber} (${listResult.count} groupes)`;
          console.log(existingInfo);

          // Si mode='replace', demander confirmation
          if (state.saveMode === 'replace') {
            const confirmReplace = confirm(
              `âš ï¸ Mode REMPLACER activÃ©!\n\n${existingInfo}\n\n` +
              `Si vous continuez, vous PERDREZ ces ${listResult.count} groupes temporaires!\n\n` +
              `Vos groupes seront renumÃ©rotÃ©s de 1 Ã  ${state.generatedGroups.length}.\n\n` +
              `Souhaitez-vous continuer?`
            );
            if (!confirmReplace) {
              showToast('Sauvegarde annulÃ©e', 'warning');
              return;
            }
          } else {
            // Mode='append': informer l'utilisateur que Ã§a va s'ajouter
            showToast(
              `Mode AJOUTER: vos groupes seront numÃ©rotÃ©s de ${listResult.maxNumber + 1} Ã  ${listResult.maxNumber + state.generatedGroups.length}`,
              'info'
            );
          }
        } else {
          // Aucun TEMP existant
          console.log('Aucun groupe TEMP existant pour ce type');
        }

        // ProcÃ©der Ã  la sauvegarde
        proceedWithSave();
      })
      .withFailureHandler(error => {
        console.error('Erreur listTempGroups:', error);
        // En cas d'erreur, continuer quand mÃªme
        showToast('Impossible de vÃ©rifier les groupes existants, sauvegarde directe...', 'warning');
        proceedWithSave();
      })
      .listTempGroups(state.groupType);

    function proceedWithSave() {
      // Si persistMode=true, FORCER saveMode='append' et envoyer l'offsetStart
      const finalSaveMode = state.persistMode ? 'append' : state.saveMode;
      const finalOffsetStart = state.persistMode ? state.tempOffsetStart : undefined;

      const payload = {
        type: state.groupType,
        saveMode: finalSaveMode,        // Force 'append' si persistMode
        offsetStart: finalOffsetStart,  // NumÃ©ro de dÃ©part explicite si persistMode
        persistMode: state.persistMode, // true = continuer la sÃ©rie
        config: {
          selectedClasses: state.selectedClasses,
          numGroups: state.numGroups,
          ...(state.groupType === 'needs' && {
            subject: state.selectedSubject,
            distributionType: state.distributionType
          }),
          ...(state.groupType === 'language' && {
            language: state.selectedLanguage
          })
        },
        groups: state.generatedGroups,
        timestamp: new Date().toISOString()
      };

      showToast('ğŸ’¾ Sauvegarde temporaire en cours...', 'info');

      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            const modeLabel = result.saveMode === 'append' ? 'ajoutÃ©s' : 'enregistrÃ©s';
            showToast(
              `âœ… Groupes ${modeLabel} de ${result.startNum} Ã  ${result.endNum} ` +
              `(${result.totalGroups} groupes, ${result.totalEleves} Ã©lÃ¨ves)`,
              'success'
            );

            // ğŸ†• MÃ©moriser la plage TEMP pour les vagues suivantes
            state.lastTempRange = {
              min: result.startNum,
              max: result.endNum,
              count: result.totalGroups,
              typePrefix: result.typePrefix
            };
            state.tempOffsetStart = result.endNum + 1; // Prochain offset

            console.log('[GroupsModule] Sauvegarde temp rÃ©ussie:', result);
            console.log('[GroupsModule] MÃ©morisation:', state.lastTempRange);

            // ğŸ†• SPRINT #1 : Sauvegarder metadata de continuation en PropertiesService
            // Permet de reprendre aprÃ¨s rechargement navigateur
            google.script.run
              .withSuccessHandler((resp) => {
                if (resp.success) {
                  console.log('[GroupsModule] âœ… Continuation metadata persistÃ©e');
                  showToast('ğŸ“Š Progression sauvegardÃ©e (continuation robuste)', 'info');
                } else {
                  console.warn('[GroupsModule] âš ï¸ Persistence metadata Ã©chouÃ©e:', resp.error);
                }
              })
              .withFailureHandler((err) => {
                console.error('[GroupsModule] âŒ Erreur persistance:', err);
              })
              .saveContinuationMetadata(state.groupType, {
                lastTempRange: state.lastTempRange,
                tempOffsetStart: state.tempOffsetStart,
                persistMode: state.persistMode
              });
          } else {
            showToast(`Erreur: ${result.error}`, 'error');
          }
        })
        .withFailureHandler(error => {
          showToast(`Erreur de sauvegarde : ${error?.message || error}`, 'error');
        })
        .saveTempGroups(payload);
    }
  }

  function finalizeTempGroupsUI() {
    if (!google?.script?.run) {
      showToast('Google Apps Script non disponible', 'error');
      return;
    }

    const typeMap = {
      'needs': 'Groupes de Besoin',
      'language': 'Groupes de Langue',
      'options': 'Groupes d\'Options'
    };

    const typeName = typeMap[state.groupType] || state.groupType;

    // DÃ©terminer le finalizeMode basÃ© sur persistMode ET saveMode
    // Si persistMode=true â†’ finalize='merge' (cumule avec existants, ne supprime pas)
    // Si persistMode=false ET saveMode='append' â†’ finalize='merge'
    // Si persistMode=false ET saveMode='replace' â†’ finalize='replace'
    const finalizeMode = (state.persistMode || state.saveMode === 'append') ? 'merge' : 'replace';

    const modeLabel = finalizeMode === 'merge' ? 'en fusionnant' : 'en remplaÃ§ant les anciens';
    showToast(`ğŸ¯ Finalisation de ${typeName} ${modeLabel}...`, 'info');

    google.script.run
      .withSuccessHandler((result) => {
        if (result.success) {
          showToast(`âœ… ${typeName} finalisÃ©s ! (${result.prefix}1, ${result.prefix}2, ...)`, 'success');

          // Si persistMode Ã©tait actif, le rÃ©initialiser aprÃ¨s finalisation rÃ©ussie
          if (state.persistMode) {
            state.persistMode = false;
            state.lastTempRange = null;
            state.tempOffsetStart = 1;
            console.log('[GroupsModule] persistMode rÃ©initialisÃ© aprÃ¨s finalisation');
          }

          console.log('[GroupsModule] Finalisation rÃ©ussie:', result);
        } else {
          showToast(`Erreur: ${result.error}`, 'error');
        }
      })
      .withFailureHandler(error => {
        showToast(`Erreur de finalisation : ${error?.message || error}`, 'error');
      })
      .finalizeTempGroups(state.groupType, finalizeMode);
  }

  function loadTempGroupsUI() {
    if (!google?.script?.run) {
      showToast('Google Apps Script non disponible', 'error');
      return;
    }

    // D'abord, vÃ©rifier quels TEMP existent
    showToast('VÃ©rification des groupes temporaires...', 'info');

    google.script.run
      .withSuccessHandler((listResult) => {
        if (listResult.success && listResult.count > 0) {
          var tempInfo = 'Groupes TEMP existants: ' +
            listResult.minNumber + ' Ã  ' + listResult.maxNumber +
            ' (' + listResult.count + ' groupes, ' + listResult.totalStudents + ' Ã©lÃ¨ves)';
          console.log(tempInfo);

          // Maintenant charger les groupes
          showToast('ğŸ“¥ Chargement des groupes temporaires...', 'info');

          google.script.run
            .withSuccessHandler((result) => {
              if (result.success && result.groups && result.groups.length > 0) {
                state.generatedGroups = result.groups;
                state.currentStep = 5;
                updateUI();
                var totalStudents = result.groups.reduce((sum, g) => sum + (g.students ? g.students.length : 0), 0);
                showToast('âœ… ' + result.totalGroups + ' groupes chargÃ©s (' + totalStudents + ' Ã©lÃ¨ves)', 'success');
                console.log('[GroupsModule] Groupes chargÃ©s:', state.generatedGroups);
              } else {
                showToast('Impossible de charger les groupes temporaires', 'warning');
              }
            })
            .withFailureHandler(error => {
              showToast('Erreur de chargement : ' + (error?.message || error), 'error');
            })
            .loadTempGroups(state.groupType);
        } else {
          showToast('Aucun groupe temporaire trouvÃ© pour le type: ' + state.groupType, 'warning');
        }
      })
      .withFailureHandler(error => {
        console.error('Erreur listTempGroups:', error);
        showToast('Impossible de lister les groupes: ' + (error?.message || error), 'error');
      })
      .listTempGroups(state.groupType);
  }

  // Alias pour compatibilitÃ© avec anciens appels
  function saveGroups() {
    saveTempGroupsUI();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ğŸ†• SPRINT #4 : SNAPSHOT MANAGEMENT (Versioning)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function showSnapshotBrowser(groupName) {
    if (!google?.script?.run) {
      showToast('Google Apps Script non disponible', 'error');
      return;
    }

    showToast(`ğŸ“¸ Chargement des versions de ${groupName}...`, 'info');

    google.script.run
      .withSuccessHandler((result) => {
        if (result.success && result.snapshots && result.snapshots.length > 0) {
          renderSnapshotDialog(groupName, result.snapshots);
        } else {
          showToast(`Aucune version pour ${groupName}`, 'info');
        }
      })
      .withFailureHandler(error => {
        showToast(`Erreur: ${error?.message || error}`, 'error');
      })
      .listGroupSnapshots(groupName);
  }

  function renderSnapshotDialog(groupName, snapshots) {
    // CrÃ©er la modale des snapshots
    const modal = documentRef.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]';
    modal.innerHTML = `
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
        <!-- En-tÃªte -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-6 rounded-t-2xl flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i class="fas fa-history text-2xl"></i>
            <div>
              <h2 class="text-2xl font-bold">Historique des Versions</h2>
              <p class="text-blue-100 text-sm">${groupName}</p>
            </div>
          </div>
          <button class="text-white hover:bg-white/20 rounded-lg p-2 transition" onclick="this.closest('[data-modal]').remove()">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <!-- Contenu -->
        <div class="overflow-y-auto flex-1 px-8 py-6">
          ${snapshots.length === 0 ? `
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-inbox text-4xl mb-3 block"></i>
              <p>Aucune version disponible</p>
            </div>
          ` : `
            <div class="space-y-3">
              ${snapshots.map((snap, idx) => `
                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 hover:border-blue-300 hover:shadow-md transition flex items-center justify-between">
                  <div class="flex-1">
                    <div class="font-semibold text-gray-800">${snap.name}</div>
                    <div class="text-sm text-gray-500 flex items-center gap-4 mt-1">
                      <span><i class="fas fa-calendar"></i> ${formatDate(snap.timestamp)}</span>
                      <span><i class="fas fa-users"></i> ${snap.studentCount || 0} Ã©lÃ¨ves</span>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button
                      class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition font-semibold text-sm"
                      onclick="restoreSnapshotUI('${groupName}', '${snap.name}')"
                    >
                      <i class="fas fa-undo"></i> Restaurer
                    </button>
                    <button
                      class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-semibold text-sm"
                      onclick="deleteSnapshotUI('${snap.name}')"
                    >
                      <i class="fas fa-trash"></i> Supprimer
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>

        <!-- Pied de page -->
        <div class="bg-gray-50 border-t px-8 py-4 rounded-b-2xl flex justify-end gap-3">
          <button
            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition font-semibold"
            onclick="this.closest('[data-modal]').remove()"
          >
            Fermer
          </button>
        </div>
      </div>
    `;
    modal.setAttribute('data-modal', 'snapshots');
    modal.onclick = (e) => {
      if (e.target === modal) modal.remove();
    };
    documentRef.body.appendChild(modal);
  }

  function restoreSnapshotUI(groupName, snapshotName) {
    if (!confirm(`ÃŠtes-vous sÃ»r de vouloir restaurer ${snapshotName} ?\nCela remplacera le groupe "${groupName}" par cette version.`)) {
      return;
    }

    showToast(`ğŸ”„ Restauration de ${snapshotName}...`, 'info');

    google.script.run
      .withSuccessHandler((result) => {
        if (result.success) {
          showToast(`âœ… ${groupName} restaurÃ© depuis ${snapshotName}`, 'success');
          // Fermer la modale
          const modal = documentRef.querySelector('[data-modal="snapshots"]');
          if (modal) modal.remove();
          // Recharger les groupes
          loadTempGroupsUI();
        } else {
          showToast(`Erreur: ${result.error}`, 'error');
        }
      })
      .withFailureHandler(error => {
        showToast(`Erreur de restauration: ${error?.message || error}`, 'error');
      })
      .restoreFromSnapshot(snapshotName);
  }

  function deleteSnapshotUI(snapshotName) {
    if (!confirm(`ÃŠtes-vous sÃ»r de vouloir supprimer ${snapshotName} ?`)) {
      return;
    }

    showToast(`ğŸ—‘ï¸ Suppression de ${snapshotName}...`, 'info');

    google.script.run
      .withSuccessHandler((result) => {
        if (result.success) {
          showToast(`âœ… ${snapshotName} supprimÃ©`, 'success');
          // RafraÃ®chir la liste (en relanÃ§ant le chargement)
          const groupName = snapshotName.split('_snapshot_')[0];
          showSnapshotBrowser(groupName);
        } else {
          showToast(`Erreur: ${result.error}`, 'error');
        }
      })
      .withFailureHandler(error => {
        showToast(`Erreur de suppression: ${error?.message || error}`, 'error');
      })
      .deleteSnapshot(snapshotName);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ğŸ†• SPRINT #5 : AUDIT LOGGING & HISTORIQUE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function showAuditHistory(groupName) {
    if (!google?.script?.run) {
      showToast('Google Apps Script non disponible', 'error');
      return;
    }

    showToast(`ğŸ“‹ Chargement de l'historique pour ${groupName}...`, 'info');

    google.script.run
      .withSuccessHandler((result) => {
        if (result.success && result.logs && result.logs.length > 0) {
          renderAuditDialog(groupName, result.logs);
        } else {
          showToast(`Aucun historique pour ${groupName}`, 'info');
        }
      })
      .withFailureHandler(error => {
        showToast(`Erreur: ${error?.message || error}`, 'error');
      })
      .getAuditLog(groupName, 50);
  }

  function renderAuditDialog(groupName, logs) {
    const modal = documentRef.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000]';
    modal.innerHTML = `
      <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[80vh] flex flex-col">
        <!-- En-tÃªte -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-8 py-6 rounded-t-2xl flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i class="fas fa-history text-2xl"></i>
            <div>
              <h2 class="text-2xl font-bold">Historique d'Audit</h2>
              <p class="text-green-100 text-sm">${groupName}</p>
            </div>
          </div>
          <button class="text-white hover:bg-white/20 rounded-lg p-2 transition" onclick="this.closest('[data-modal]').remove()">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <!-- Contenu -->
        <div class="overflow-y-auto flex-1 px-8 py-6">
          ${logs.length === 0 ? `
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-inbox text-4xl mb-3 block"></i>
              <p>Aucun historique d'audit</p>
            </div>
          ` : `
            <div class="space-y-2">
              <table class="w-full border-collapse text-sm">
                <thead>
                  <tr class="bg-gray-100 border-b-2 border-gray-300">
                    <th class="px-3 py-2 text-left font-semibold">#</th>
                    <th class="px-3 py-2 text-left font-semibold">Date/Heure</th>
                    <th class="px-3 py-2 text-left font-semibold">OpÃ©ration</th>
                    <th class="px-3 py-2 text-left font-semibold">Type</th>
                    <th class="px-3 py-2 text-left font-semibold">Utilisateur</th>
                    <th class="px-3 py-2 text-left font-semibold">Statut</th>
                  </tr>
                </thead>
                <tbody>
                  ${logs.map((log, idx) => `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                      <td class="px-3 py-2 text-gray-600">${log.index}</td>
                      <td class="px-3 py-2 text-gray-700 text-xs">${formatDate(log.timestamp)}</td>
                      <td class="px-3 py-2">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${getOperationBadgeClass(log.operation)}">
                          ${log.operation}
                        </span>
                      </td>
                      <td class="px-3 py-2 text-gray-700 text-xs">${log.groupType}</td>
                      <td class="px-3 py-2 text-gray-700 text-xs">${log.user}</td>
                      <td class="px-3 py-2">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${log.status === 'SUCCESS' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                          ${log.status}
                        </span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `}
        </div>

        <!-- Pied de page -->
        <div class="bg-gray-50 border-t px-8 py-4 rounded-b-2xl flex justify-between gap-3">
          <button
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition font-semibold text-sm"
            onclick="exportAuditReportUI('${groupName}')"
          >
            <i class="fas fa-download"></i> Exporter JSON
          </button>
          <button
            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition font-semibold"
            onclick="this.closest('[data-modal]').remove()"
          >
            Fermer
          </button>
        </div>
      </div>
    `;
    modal.setAttribute('data-modal', 'audit');
    modal.onclick = (e) => {
      if (e.target === modal) modal.remove();
    };
    documentRef.body.appendChild(modal);
  }

  function getOperationBadgeClass(operation) {
    const classes = {
      'SAVE': 'bg-blue-100 text-blue-700',
      'FINALIZE': 'bg-green-100 text-green-700',
      'RESTORE': 'bg-orange-100 text-orange-700',
      'CREATE_SNAPSHOT': 'bg-purple-100 text-purple-700',
      'DELETE': 'bg-red-100 text-red-700'
    };
    return classes[operation] || 'bg-gray-100 text-gray-700';
  }

  function exportAuditReportUI(groupName) {
    showToast(`ğŸ“¥ GÃ©nÃ©ration du rapport d'audit pour ${groupName}...`, 'info');

    google.script.run
      .withSuccessHandler((result) => {
        if (result.success && result.json) {
          // TÃ©lÃ©charger comme fichier JSON
          const blob = new Blob([result.json], { type: 'application/json;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = documentRef.createElement('a');
          link.href = url;
          link.download = `audit_${groupName}_${new Date().toISOString().split('T')[0]}.json`;
          documentRef.body.appendChild(link);
          link.click();
          documentRef.body.removeChild(link);
          URL.revokeObjectURL(url);

          showToast(`âœ… Rapport d'audit exportÃ©: ${link.download}`, 'success');
        } else {
          showToast(`Erreur: ${result.error}`, 'error');
        }
      })
      .withFailureHandler(error => {
        showToast(`Erreur d'export: ${error?.message || error}`, 'error');
      })
      .exportAuditReport(groupName);
  }

  function exportToPDF() {
    showToast('Export PDF en dÃ©veloppement', 'info');
    // TODO: ImplÃ©menter export PDF
  }

  function exportToCSV() {
    if (!state.generatedGroups || state.generatedGroups.length === 0) {
      showToast('Aucun groupe Ã  exporter', 'warning');
      return;
    }

    // CrÃ©er le CSV
    let csv = 'Groupe,Nom,PrÃ©nom,Sexe,Classe,LV2\n';

    state.generatedGroups.forEach(group => {
      group.students.forEach(student => {
        csv += `"${group.name}","${student.nom}","${student.prenom}","${student.sexe || ''}","${student.classe || ''}","${student.lv2 || ''}"\n`;
      });
    });

    // TÃ©lÃ©charger
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = documentRef.createElement('a');
    link.href = url;
    link.download = `groupes_${new Date().toISOString().split('T')[0]}.csv`;
    documentRef.body.appendChild(link);
    link.click();
    documentRef.body.removeChild(link);
    URL.revokeObjectURL(url);

    showToast('Export CSV tÃ©lÃ©chargÃ©', 'success');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  STYLES CSS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function injectStyles() {
    if (documentRef.getElementById('groups-module-complete-styles')) return;

    const style = documentRef.createElement('style');
    style.id = 'groups-module-complete-styles';
    style.textContent = `
      @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slide-in {
        from { transform: translateX(30px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .animate-fade-in { animation: fade-in 0.2s ease; }
      .animate-slide-in { animation: slide-in 0.3s ease; }

      /* STEPPER */
      .stepper-step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
      }

      .step-number {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        background: #e2e8f0;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s ease;
      }

      .step-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        transition: all 0.3s ease;
      }

      .stepper-step.active .step-number {
        background: linear-gradient(135deg, #6366f1, #7c3aed);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
      }

      .stepper-step.active .step-label {
        color: #4f46e5;
      }

      .stepper-step.current .step-number {
        transform: scale(1.1);
      }

      .step-connector {
        flex: 1;
        height: 2px;
        background: #e2e8f0;
        transition: all 0.3s ease;
      }

      /* GROUP TYPE CARDS */
      .group-type-card {
        position: relative;
        border: 3px solid #e2e8f0;
        border-radius: 1.5rem;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }

      .group-type-card:hover:not(.disabled) {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px -20px rgba(99, 102, 241, 0.3);
        border-color: #c7d2fe;
      }

      .group-type-card.selected {
        border-color: #6366f1;
        background: linear-gradient(135deg, #eff6ff, #faf5ff);
      }

      .group-type-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .group-type-card .icon-wrapper {
        margin-bottom: 1rem;
      }

      .group-type-card .icon {
        font-size: 3rem;
      }

      .group-type-card .title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
      }

      .group-type-card .description {
        font-size: 0.875rem;
        color: #64748b;
        line-height: 1.5;
      }

      .group-type-card .check-icon {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        color: #6366f1;
      }

      .badge-disabled {
        display: inline-block;
        margin-top: 0.5rem;
        padding: 0.25rem 0.75rem;
        background: #fbbf24;
        color: white;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .badge-recommended {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #10b981;
        color: white;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      /* INFO CARDS */
      .info-card {
        border: 2px solid;
        border-radius: 1.25rem;
        padding: 1.5rem;
      }

      /* CLASS SELECTION */
      .class-checkbox-card {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
      }

      .class-checkbox-card:hover {
        border-color: #c7d2fe;
        background: #f8fafc;
      }

      .class-checkbox-card.selected {
        border-color: #6366f1;
        background: linear-gradient(135deg, #eff6ff, #faf5ff);
      }

      .class-checkbox {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .class-name {
        font-weight: 600;
        color: #1e293b;
      }

      .class-checkbox-card .check-icon {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
        font-size: 1rem;
        color: #6366f1;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .class-checkbox-card.selected .check-icon {
        opacity: 1;
      }

      /* CONFIG CARDS */
      .config-card {
        border: 2px solid #e2e8f0;
        border-radius: 1.25rem;
        background: white;
        overflow: hidden;
      }

      .config-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-bottom: 1px solid #e2e8f0;
      }

      .config-body {
        padding: 1.5rem;
      }

      .radio-card {
        position: relative;
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .radio-card:hover {
        border-color: #c7d2fe;
        background: #f8fafc;
      }

      .radio-card.selected {
        border-color: #6366f1;
        background: linear-gradient(135deg, #eff6ff, #faf5ff);
      }

      .radio-card input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .radio-card .check-icon {
        margin-left: auto;
        color: #6366f1;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .radio-card.selected .check-icon {
        opacity: 1;
      }

      .number-btn {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.5rem;
        border: 2px solid #e2e8f0;
        background: white;
        color: #64748b;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .number-btn:hover {
        border-color: #6366f1;
        color: #6366f1;
        background: #eff6ff;
      }

      .number-display {
        font-size: 2rem;
        font-weight: 700;
        color: #6366f1;
        min-width: 3rem;
        text-align: center;
      }

      /* SUMMARY CARDS */
      .summary-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 1.25rem;
        background: white;
      }

      .summary-icon {
        width: 3.5rem;
        height: 3.5rem;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
      }

      .summary-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .summary-value {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1e293b;
        margin-top: 0.25rem;
      }

      /* GROUP CARDS */
      .group-card {
        border: 2px solid #e2e8f0;
        border-radius: 1.25rem;
        background: white;
        overflow: hidden;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 150px; /* hauteur min rÃ©duite pour maximiser l'espace de liste */
      }

      .group-card:hover {
        box-shadow: 0 8px 24px -12px rgba(0, 0, 0, 0.15);
      }

      .group-header {
        padding: 1rem 1.25rem;
        background: linear-gradient(135deg, #6366f1, #7c3aed);
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }

      .group-title {
        font-weight: 700;
        font-size: 1rem;
      }

      .group-count {
        font-size: 0.875rem;
        opacity: 0.9;
      }

      .group-stats {
        padding: 0.75rem 1.25rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        flex-shrink: 0;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: #475569;
      }

      .group-students {
        padding: 1rem;
        overflow-y: auto;
        flex: 1; /* Prend tout l'espace disponible */
        min-height: 0; /* Important pour flexbox : permet au scroll de marcher */
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
      }

      /* Scrollbar personnalisÃ©e (Webkit) */
      .group-students::-webkit-scrollbar {
        width: 6px;
      }

      .group-students::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }

      .group-students::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      .group-students::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* STUDENT CARDS */
      .student-card {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem;
        margin-bottom: 0.25rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        background: white;
        cursor: move;
        transition: all 0.2s ease;
        font-size: 0.8rem;
      }

      .student-card:hover {
        border-color: #c7d2fe;
        background: #f8fafc;
        box-shadow: 0 2px 8px -4px rgba(99, 102, 241, 0.2);
      }

      .student-sexe {
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.75rem;
      }

      .student-sexe.sexe-f {
        background: #fce7f3;
        color: #ec4899;
      }

      .student-sexe.sexe-m {
        background: #dbeafe;
        color: #3b82f6;
      }

      .student-name {
        font-weight: 600;
        font-size: 0.8rem;
        color: #1e293b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 1;
        min-width: 0;
      }

      .student-meta {
        font-size: 0.7rem;
        color: #64748b;
        white-space: nowrap;
      }

      .student-source {
        font-size: 0.7rem;
        color: #94a3b8;
        white-space: nowrap;
      }

      .student-scores {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
      }

      .score-badge {
        padding: 0.2rem 0.4rem;
        background: #f1f5f9;
        border-radius: 0.375rem;
        font-size: 0.7rem;
        font-weight: 600;
        color: #475569;
        white-space: nowrap;
      }

      .score-badge.avg {
        background: linear-gradient(135deg, #6366f1, #7c3aed);
        color: white;
      }

      .drag-handle {
        cursor: grab;
      }

      .drag-handle:active {
        cursor: grabbing;
      }

      /* SORTABLE STATES */
      .sortable-ghost {
        opacity: 0.4;
        background: #eff6ff;
      }

      .sortable-chosen {
        border-color: #6366f1;
        box-shadow: 0 8px 24px -12px rgba(99, 102, 241, 0.4);
      }

      .sortable-drag {
        transform: rotate(3deg);
      }

      /* ACTION BUTTONS */
      .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
      }

      .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px -6px rgba(0, 0, 0, 0.2);
      }

      /* SPINNERS */
      .spinner-large {
        width: 4rem;
        height: 4rem;
        border: 4px solid #e2e8f0;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .delay-100 { animation-delay: 0.1s; }
      .delay-200 { animation-delay: 0.2s; }
    `;

    documentRef.head.appendChild(style);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  MODULE PUBLIC API
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const GroupsModuleComplete = {
    version: '1.0.0',

    init() {
      console.log('âœ… GroupsModuleComplete initialisÃ©');
    },

    open() {
      console.log('ğŸš€ Ouverture du module complet de groupes');
      createModal();
    },

    close: closeModal,

    getState() {
      return { ...state };
    },

    // Fonctions publiques pour la gestion des groupes temporaires
    saveTempGroupsUI,
    loadTempGroupsUI,
    finalizeTempGroupsUI
  };

  // Injecter les styles
  injectStyles();

  // Exposer le module
  windowRef.GroupsModuleComplete = GroupsModuleComplete;

  // Initialisation automatique
  if (documentRef.readyState === 'loading') {
    documentRef.addEventListener('DOMContentLoaded', () => {
      GroupsModuleComplete.init();
    });
  } else {
    GroupsModuleComplete.init();
  }

  console.log('âœ… Module Complet de Gestion des Groupes chargÃ© avec succÃ¨s');

})(typeof window !== 'undefined' ? window : this);
</script>
